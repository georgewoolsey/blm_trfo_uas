<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 2 Point Cloud Processing | BLM Tres Rios Field Office: Dawson project area UAS data</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 2 Point Cloud Processing | BLM Tres Rios Field Office: Dawson project area UAS data" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 2 Point Cloud Processing | BLM Tres Rios Field Office: Dawson project area UAS data" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="slash-piles.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="processing.html"><a href="processing.html"><i class="fa fa-check"></i><b>2</b> Point Cloud Processing</a>
<ul>
<li class="chapter" data-level="2.1" data-path="processing.html"><a href="processing.html#data-location"><i class="fa fa-check"></i><b>2.1</b> Data Location</a></li>
<li class="chapter" data-level="2.2" data-path="processing.html"><a href="processing.html#point-cloud-to-raster-cloud2raster"><i class="fa fa-check"></i><b>2.2</b> Point Cloud to Raster: <code>cloud2raster()</code></a></li>
<li class="chapter" data-level="2.3" data-path="processing.html"><a href="processing.html#individial-tree-detection-tuning-itd_tuning"><i class="fa fa-check"></i><b>2.3</b> Individial Tree Detection Tuning: <code id="itd">itd_tuning()</code></a></li>
<li class="chapter" data-level="2.4" data-path="processing.html"><a href="processing.html#tree-extraction-raster2trees"><i class="fa fa-check"></i><b>2.4</b> Tree Extraction: <code id="trees">raster2trees()</code></a></li>
<li class="chapter" data-level="2.5" data-path="processing.html"><a href="processing.html#cbh-modeling-trees_cbh"><i class="fa fa-check"></i><b>2.5</b> CBH Modeling: <code>trees_cbh()</code></a></li>
<li class="chapter" data-level="2.6" data-path="processing.html"><a href="processing.html#dbh-modeling-trees_dbh"><i class="fa fa-check"></i><b>2.6</b> DBH Modeling: <code>trees_dbh()</code></a></li>
<li class="chapter" data-level="2.7" data-path="processing.html"><a href="processing.html#hmd-modeling-trees_hmd"><i class="fa fa-check"></i><b>2.7</b> HMD Modeling: <code>trees_hmd()</code></a></li>
<li class="chapter" data-level="2.8" data-path="processing.html"><a href="processing.html#forest-type-trees_type"><i class="fa fa-check"></i><b>2.8</b> Forest Type: <code id="trees_type">trees_type()</code></a></li>
<li class="chapter" data-level="2.9" data-path="processing.html"><a href="processing.html#combine-data"><i class="fa fa-check"></i><b>2.9</b> Combine data</a></li>
<li class="chapter" data-level="2.10" data-path="processing.html"><a href="processing.html#crown-biomass-trees_biomass"><i class="fa fa-check"></i><b>2.10</b> Crown Biomass: <code id="trees_biomass">trees_biomass()</code></a></li>
<li class="chapter" data-level="2.11" data-path="processing.html"><a href="processing.html#processing-time-summary"><i class="fa fa-check"></i><b>2.11</b> Processing Time Summary</a></li>
<li class="chapter" data-level="2.12" data-path="processing.html"><a href="processing.html#data-export"><i class="fa fa-check"></i><b>2.12</b> Data Export</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="slash-piles.html"><a href="slash-piles.html"><i class="fa fa-check"></i><b>3</b> Slash Piles</a>
<ul>
<li class="chapter" data-level="3.1" data-path="slash-piles.html"><a href="slash-piles.html#slash-pile-detection-workflow"><i class="fa fa-check"></i><b>3.1</b> Slash Pile Detection Workflow</a></li>
<li class="chapter" data-level="3.2" data-path="slash-piles.html"><a href="slash-piles.html#candidate-pile-review"><i class="fa fa-check"></i><b>3.2</b> Candidate Pile Review</a></li>
<li class="chapter" data-level="3.3" data-path="slash-piles.html"><a href="slash-piles.html#slash-pile-summary-statistics"><i class="fa fa-check"></i><b>3.3</b> Slash Pile Summary Statistics</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="treatment-unit-silvicultural-summary.html"><a href="treatment-unit-silvicultural-summary.html"><i class="fa fa-check"></i><b>4</b> Treatment Unit Silvicultural Summary</a>
<ul>
<li class="chapter" data-level="4.1" data-path="treatment-unit-silvicultural-summary.html"><a href="treatment-unit-silvicultural-summary.html#remove-slash-piles"><i class="fa fa-check"></i><b>4.1</b> Remove Slash Piles</a></li>
<li class="chapter" data-level="4.2" data-path="treatment-unit-silvicultural-summary.html"><a href="treatment-unit-silvicultural-summary.html#function-to-calculate-silviclutural-metrics"><i class="fa fa-check"></i><b>4.2</b> Function to Calculate Silviclutural Metrics</a></li>
<li class="chapter" data-level="4.3" data-path="treatment-unit-silvicultural-summary.html"><a href="treatment-unit-silvicultural-summary.html#treatment-unit-summaries"><i class="fa fa-check"></i><b>4.3</b> Treatment Unit Summaries</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="treatment-unit-silvicultural-summary.html"><a href="treatment-unit-silvicultural-summary.html#tabular"><i class="fa fa-check"></i><b>4.3.1</b> Tabular</a></li>
<li class="chapter" data-level="4.3.2" data-path="treatment-unit-silvicultural-summary.html"><a href="treatment-unit-silvicultural-summary.html#visual"><i class="fa fa-check"></i><b>4.3.2</b> Visual</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">BLM Tres Rios Field Office: Dawson project area UAS data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="processing" class="section level1 hasAnchor" number="2">
<h1><span class="header-section-number">Section 2</span> Point Cloud Processing<a href="processing.html#processing" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this section we’ll process the <a href="#data_desc">raw point cloud data</a> using <a href="https://github.com/georgewoolsey/cloud2trees"><code>cloud2trees</code></a> developed to provide accessible routines for processing point cloud data collected by airborne lidar or generated using UAS imagery and photogrammetry (e.g. structure from motion).</p>
<p>The <code>cloud2trees</code> package can be installed by following the directions listed in the <a href="https://github.com/georgewoolsey/cloud2trees">README file on GitHub</a>. If one is still experiencing difficulties installing the package, see the <a href="https://github.com/georgewoolsey/cloud2trees/blob/main/inst/examples/example.R">example.R file</a> which details how to install the package using a virgin R instance.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="processing.html#cb1-1" tabindex="-1"></a><span class="do">## remotes helps us get packages hosted on github</span></span>
<span id="cb1-2"><a href="processing.html#cb1-2" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;remotes&quot;</span>)</span>
<span id="cb1-3"><a href="processing.html#cb1-3" tabindex="-1"></a><span class="do">## get cloud2trees</span></span>
<span id="cb1-4"><a href="processing.html#cb1-4" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="at">repo =</span> <span class="st">&quot;georgewoolsey/cloud2trees&quot;</span>, <span class="at">upgrade =</span> F)</span></code></pre></div>
<p>Load the standard libraries we use to do work</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="processing.html#cb2-1" tabindex="-1"></a><span class="co"># bread-and-butter</span></span>
<span id="cb2-2"><a href="processing.html#cb2-2" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># the tidyverse</span></span>
<span id="cb2-3"><a href="processing.html#cb2-3" tabindex="-1"></a><span class="fu">library</span>(viridis) <span class="co"># viridis colors</span></span>
<span id="cb2-4"><a href="processing.html#cb2-4" tabindex="-1"></a><span class="fu">library</span>(harrypotter) <span class="co"># hp colors</span></span>
<span id="cb2-5"><a href="processing.html#cb2-5" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer) <span class="co"># brewer colors</span></span>
<span id="cb2-6"><a href="processing.html#cb2-6" tabindex="-1"></a><span class="fu">library</span>(scales) <span class="co"># work with number and plot scales</span></span>
<span id="cb2-7"><a href="processing.html#cb2-7" tabindex="-1"></a><span class="fu">library</span>(latex2exp)</span>
<span id="cb2-8"><a href="processing.html#cb2-8" tabindex="-1"></a></span>
<span id="cb2-9"><a href="processing.html#cb2-9" tabindex="-1"></a><span class="co"># visualization</span></span>
<span id="cb2-10"><a href="processing.html#cb2-10" tabindex="-1"></a><span class="fu">library</span>(mapview) <span class="co"># interactive html maps</span></span>
<span id="cb2-11"><a href="processing.html#cb2-11" tabindex="-1"></a><span class="fu">library</span>(kableExtra) <span class="co"># tables</span></span>
<span id="cb2-12"><a href="processing.html#cb2-12" tabindex="-1"></a><span class="fu">library</span>(patchwork) <span class="co"># combine plots</span></span>
<span id="cb2-13"><a href="processing.html#cb2-13" tabindex="-1"></a></span>
<span id="cb2-14"><a href="processing.html#cb2-14" tabindex="-1"></a><span class="co"># spatial analysis</span></span>
<span id="cb2-15"><a href="processing.html#cb2-15" tabindex="-1"></a><span class="fu">library</span>(terra) <span class="co"># raster</span></span>
<span id="cb2-16"><a href="processing.html#cb2-16" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># simple features</span></span>
<span id="cb2-17"><a href="processing.html#cb2-17" tabindex="-1"></a><span class="fu">library</span>(lidR) <span class="co"># lidar data</span></span>
<span id="cb2-18"><a href="processing.html#cb2-18" tabindex="-1"></a><span class="fu">library</span>(cloud2trees) <span class="co"># the cloud2trees</span></span></code></pre></div>
<div id="data-location" class="section level2 hasAnchor" number="2.1">
<h2><span class="header-section-number">2.1</span> Data Location<a href="processing.html#data-location" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s check out the location of the data we got</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="processing.html#cb3-1" tabindex="-1"></a><span class="co"># directory with the downloaded .las|.laz files</span></span>
<span id="cb3-2"><a href="processing.html#cb3-2" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="st">&quot;d:/BLM_CO_SWDF_DawsonFuelsTreatment/Final/PointCloud/Tiles&quot;</span></span>
<span id="cb3-3"><a href="processing.html#cb3-3" tabindex="-1"></a><span class="co"># f &lt;- &quot;d:/BLM_CO_SWDF_DawsonFuelsTreatment/Final/PointCloud/Full/&quot;</span></span>
<span id="cb3-4"><a href="processing.html#cb3-4" tabindex="-1"></a><span class="co"># is there data?</span></span>
<span id="cb3-5"><a href="processing.html#cb3-5" tabindex="-1"></a><span class="fu">list.files</span>(f, <span class="at">pattern =</span> <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb3-6"><a href="processing.html#cb3-6" tabindex="-1"></a><span class="co"># what files are in here?</span></span>
<span id="cb3-7"><a href="processing.html#cb3-7" tabindex="-1"></a><span class="fu">list.files</span>(f, <span class="at">pattern =</span> <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code></pre></div>
<p>what information does <code>lidR</code> read from the catalog?</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="processing.html#cb4-1" tabindex="-1"></a>ctg_temp <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">readLAScatalog</span>(f)</span>
<span id="cb4-2"><a href="processing.html#cb4-2" tabindex="-1"></a>ctg_temp</span></code></pre></div>
<p>that’s a lot of points…can an ordinary laptop handle it? we’ll find out.</p>
<p>We’ll plot our point cloud data tiles real quick</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="processing.html#cb5-1" tabindex="-1"></a>ctg_temp<span class="sc">@</span>data <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="processing.html#cb5-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb5-3"><a href="processing.html#cb5-3" tabindex="-1"></a>    <span class="at">nm =</span></span>
<span id="cb5-4"><a href="processing.html#cb5-4" tabindex="-1"></a>      <span class="fu">basename</span>(filename) <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="processing.html#cb5-5" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.[^.]+$&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="processing.html#cb5-6" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;BLM_CO_SWDF_DawsonFuelsTreatment_PointCloud_&quot;</span>)</span>
<span id="cb5-7"><a href="processing.html#cb5-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="processing.html#cb5-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb5-9"><a href="processing.html#cb5-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">fill=</span><span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb5-10"><a href="processing.html#cb5-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>()</span></code></pre></div>
<p>oh no. something weird is going on with the location of these point cloud tiles…perhaps that’s the reason for the “0 points/m2” message from <code>lidR</code> above</p>
<p>no worries, <code>cloud2trees</code> has built-in functionality to handle corrupt point cloud data. let’s see if that functionality can help clean this up</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="processing.html#cb6-1" tabindex="-1"></a>ctg_temp <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="processing.html#cb6-2" tabindex="-1"></a>  cloud2trees<span class="sc">:::</span><span class="fu">check_las_ctg_empty</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="processing.html#cb6-3" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;data&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-4"><a href="processing.html#cb6-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb6-5"><a href="processing.html#cb6-5" tabindex="-1"></a>    <span class="at">nm =</span></span>
<span id="cb6-6"><a href="processing.html#cb6-6" tabindex="-1"></a>      <span class="fu">basename</span>(filename) <span class="sc">%&gt;%</span></span>
<span id="cb6-7"><a href="processing.html#cb6-7" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.[^.]+$&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="processing.html#cb6-8" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;BLM_CO_SWDF_DawsonFuelsTreatment_PointCloud_&quot;</span>)</span>
<span id="cb6-9"><a href="processing.html#cb6-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-10"><a href="processing.html#cb6-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb6-11"><a href="processing.html#cb6-11" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">fill=</span><span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb6-12"><a href="processing.html#cb6-12" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_sf_label</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">label =</span> nm),<span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb6-13"><a href="processing.html#cb6-13" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p>that’s better. let’s look at this on a map to orient ourselves</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="processing.html#cb7-1" tabindex="-1"></a>ctg_temp <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="processing.html#cb7-2" tabindex="-1"></a>  cloud2trees<span class="sc">:::</span><span class="fu">check_las_ctg_empty</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="processing.html#cb7-3" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;data&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-4"><a href="processing.html#cb7-4" tabindex="-1"></a>  mapview<span class="sc">::</span><span class="fu">mapview</span>(<span class="at">popup =</span> F, <span class="at">layer.name =</span> <span class="st">&quot;point cloud tile&quot;</span>)</span></code></pre></div>
</div>
<div id="point-cloud-to-raster-cloud2raster" class="section level2 hasAnchor" number="2.2">
<h2><span class="header-section-number">2.2</span> Point Cloud to Raster: <code>cloud2raster()</code><a href="processing.html#point-cloud-to-raster-cloud2raster" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Although the <code>cloud2trees::cloud2trees()</code> function combines methods in the <code>cloud2trees</code> package for an all-in-one approach, we’ll instead use the <code>cloud2trees::cloud2raster()</code> function to generate a CHM from the point cloud that we can work with to perform both individual tree detection and slash pile identification (discussed later).</p>
<p>We’ll set the options in the function to generate a CHM which represents a DSM with the ground removed and no other filtering. This high resolution (i.e. fine-grain) CHM will serve as the foundation for tree detection and slash pile detection as we can manipulate it to optimize the processing for both methods.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="processing.html#cb8-1" tabindex="-1"></a><span class="co"># outdir</span></span>
<span id="cb8-2"><a href="processing.html#cb8-2" tabindex="-1"></a>c2t_output_dir <span class="ot">&lt;-</span> <span class="st">&quot;../data&quot;</span></span>
<span id="cb8-3"><a href="processing.html#cb8-3" tabindex="-1"></a>c2t_process_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(c2t_output_dir, <span class="st">&quot;point_cloud_processing_delivery&quot;</span>)</span>
<span id="cb8-4"><a href="processing.html#cb8-4" tabindex="-1"></a>c2t_tracking_fnm <span class="ot">&lt;-</span> <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;processed_tracking_data.csv&quot;</span>)</span>
<span id="cb8-5"><a href="processing.html#cb8-5" tabindex="-1"></a><span class="do">##############################################################</span></span>
<span id="cb8-6"><a href="processing.html#cb8-6" tabindex="-1"></a><span class="co"># cloud2trees::cloud2raster</span></span>
<span id="cb8-7"><a href="processing.html#cb8-7" tabindex="-1"></a><span class="do">##############################################################</span></span>
<span id="cb8-8"><a href="processing.html#cb8-8" tabindex="-1"></a><span class="cf">if</span>(</span>
<span id="cb8-9"><a href="processing.html#cb8-9" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">file.exists</span>( <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;chm_0.1m.tif&quot;</span>) )</span>
<span id="cb8-10"><a href="processing.html#cb8-10" tabindex="-1"></a>  <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>( <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;dtm_0.25m.tif&quot;</span>) )</span>
<span id="cb8-11"><a href="processing.html#cb8-11" tabindex="-1"></a>){</span>
<span id="cb8-12"><a href="processing.html#cb8-12" tabindex="-1"></a>  <span class="co"># time it</span></span>
<span id="cb8-13"><a href="processing.html#cb8-13" tabindex="-1"></a>  st_temp <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb8-14"><a href="processing.html#cb8-14" tabindex="-1"></a>  <span class="co"># run it</span></span>
<span id="cb8-15"><a href="processing.html#cb8-15" tabindex="-1"></a>  <span class="co"># cloud2trees</span></span>
<span id="cb8-16"><a href="processing.html#cb8-16" tabindex="-1"></a>  cloud2raster_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">cloud2raster</span>(</span>
<span id="cb8-17"><a href="processing.html#cb8-17" tabindex="-1"></a>    <span class="at">output_dir =</span> c2t_output_dir</span>
<span id="cb8-18"><a href="processing.html#cb8-18" tabindex="-1"></a>    , <span class="at">input_las_dir =</span> f</span>
<span id="cb8-19"><a href="processing.html#cb8-19" tabindex="-1"></a>    , <span class="at">accuracy_level =</span> <span class="dv">2</span></span>
<span id="cb8-20"><a href="processing.html#cb8-20" tabindex="-1"></a>    , <span class="at">keep_intrmdt =</span> T</span>
<span id="cb8-21"><a href="processing.html#cb8-21" tabindex="-1"></a>    , <span class="at">dtm_res_m =</span> <span class="fl">0.25</span></span>
<span id="cb8-22"><a href="processing.html#cb8-22" tabindex="-1"></a>    , <span class="at">chm_res_m =</span> <span class="fl">0.1</span></span>
<span id="cb8-23"><a href="processing.html#cb8-23" tabindex="-1"></a>    , <span class="at">min_height =</span> <span class="dv">0</span> <span class="co"># effectively generates a DSM based on non-ground points</span></span>
<span id="cb8-24"><a href="processing.html#cb8-24" tabindex="-1"></a>  )</span>
<span id="cb8-25"><a href="processing.html#cb8-25" tabindex="-1"></a>  </span>
<span id="cb8-26"><a href="processing.html#cb8-26" tabindex="-1"></a>  <span class="co"># timer</span></span>
<span id="cb8-27"><a href="processing.html#cb8-27" tabindex="-1"></a>  mins_temp <span class="ot">&lt;-</span> <span class="fu">difftime</span>(<span class="fu">Sys.time</span>(),st_temp,<span class="at">units =</span> <span class="st">&quot;mins&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb8-28"><a href="processing.html#cb8-28" tabindex="-1"></a>  <span class="co"># save tracking</span></span>
<span id="cb8-29"><a href="processing.html#cb8-29" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb8-30"><a href="processing.html#cb8-30" tabindex="-1"></a>    <span class="at">timer_cloud2raster_mins =</span> mins_temp</span>
<span id="cb8-31"><a href="processing.html#cb8-31" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-32"><a href="processing.html#cb8-32" tabindex="-1"></a>    <span class="fu">write.csv</span>(</span>
<span id="cb8-33"><a href="processing.html#cb8-33" tabindex="-1"></a>      <span class="at">file =</span> c2t_tracking_fnm</span>
<span id="cb8-34"><a href="processing.html#cb8-34" tabindex="-1"></a>      , <span class="at">row.names =</span> F, <span class="at">append =</span> F</span>
<span id="cb8-35"><a href="processing.html#cb8-35" tabindex="-1"></a>    )</span>
<span id="cb8-36"><a href="processing.html#cb8-36" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb8-37"><a href="processing.html#cb8-37" tabindex="-1"></a>  dtm_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>( <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;dtm_0.25m.tif&quot;</span>) )</span>
<span id="cb8-38"><a href="processing.html#cb8-38" tabindex="-1"></a>  chm_temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>( <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;chm_0.1m.tif&quot;</span>) )</span>
<span id="cb8-39"><a href="processing.html#cb8-39" tabindex="-1"></a>  </span>
<span id="cb8-40"><a href="processing.html#cb8-40" tabindex="-1"></a>  cloud2raster_ans <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-41"><a href="processing.html#cb8-41" tabindex="-1"></a>    <span class="st">&quot;dtm_rast&quot;</span> <span class="ot">=</span> dtm_temp</span>
<span id="cb8-42"><a href="processing.html#cb8-42" tabindex="-1"></a>    , <span class="st">&quot;chm_rast&quot;</span> <span class="ot">=</span> chm_temp</span>
<span id="cb8-43"><a href="processing.html#cb8-43" tabindex="-1"></a>  )</span>
<span id="cb8-44"><a href="processing.html#cb8-44" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s see what we got from <code>cloud2trees::cloud2raster()</code></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="processing.html#cb9-1" tabindex="-1"></a>cloud2raster_ans <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span></code></pre></div>
<pre><code>## [1] &quot;dtm_rast&quot; &quot;chm_rast&quot;</code></pre>
<p>there’s a DTM</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="processing.html#cb11-1" tabindex="-1"></a><span class="co"># plot to check out the fine-resolution DTM raster</span></span>
<span id="cb11-2"><a href="processing.html#cb11-2" tabindex="-1"></a>cloud2raster_ans<span class="sc">$</span>dtm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="processing.html#cb11-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">col =</span> harrypotter<span class="sc">::</span><span class="fu">hp</span>(<span class="at">n=</span><span class="dv">100</span>, <span class="at">option =</span> <span class="st">&quot;mischief&quot;</span>), <span class="at">main =</span> <span class="st">&quot;DTM (m)&quot;</span>)</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-14-1.png" alt="" width="1008" /></p>
<p>there’s a CHM</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="processing.html#cb12-1" tabindex="-1"></a><span class="co"># plot to check out the fine-resolution CHM raster</span></span>
<span id="cb12-2"><a href="processing.html#cb12-2" tabindex="-1"></a>cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="processing.html#cb12-3" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(<span class="at">col =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="at">n=</span><span class="dv">100</span>), <span class="at">main =</span> <span class="st">&quot;CHM (m)&quot;</span>)</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-15-1.png" alt="" width="1008" /></p>
<p>let’s see some details about the CHM</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="processing.html#cb13-1" tabindex="-1"></a><span class="co"># what chm?</span></span>
<span id="cb13-2"><a href="processing.html#cb13-2" tabindex="-1"></a>cloud2raster_ans<span class="sc">$</span>chm_rast</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## size        : 27426, 42203, 1  (nrow, ncol, nlyr)
## resolution  : 0.1, 0.1  (x, y)
## extent      : 706698.8, 710919.1, 4191874, 4194616  (xmin, xmax, ymin, ymax)
## coord. ref. : NAD83(2011) / UTM zone 12N (EPSG:6341) 
## source      : chm_0.1m.tif 
## name        : focal_mean 
## min value   :       0.00 
## max value   :      22.59</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="processing.html#cb15-1" tabindex="-1"></a><span class="co"># what data?</span></span>
<span id="cb15-2"><a href="processing.html#cb15-2" tabindex="-1"></a>cloud2raster_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    focal_mean   
##  Min.   : 0.02  
##  1st Qu.: 1.94  
##  Median : 3.36  
##  Mean   : 3.30  
##  3rd Qu.: 4.55  
##  Max.   :20.31  
##  NA&#39;s   :78839</code></pre>
<p>for tree detection, we’ll aggregate the CHM to a lower resolution (i.e. coarser) to smooth out some of the fine detail that can increase the noise in the tree detection processing. This aggregation process also will speed up the processing and reduce the chances of computational memory issues.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="processing.html#cb17-1" tabindex="-1"></a><span class="do">##################################################################</span></span>
<span id="cb17-2"><a href="processing.html#cb17-2" tabindex="-1"></a><span class="co"># aggregate to make raster more coarse for tree detection</span></span>
<span id="cb17-3"><a href="processing.html#cb17-3" tabindex="-1"></a><span class="do">##################################################################</span></span>
<span id="cb17-4"><a href="processing.html#cb17-4" tabindex="-1"></a><span class="co"># first, we&#39;ll borrow from the `cloud2trees` codebase to get a function to change the resolution of a raster exactly</span></span>
<span id="cb17-5"><a href="processing.html#cb17-5" tabindex="-1"></a><span class="do">###___________________________________________###</span></span>
<span id="cb17-6"><a href="processing.html#cb17-6" tabindex="-1"></a><span class="co"># adjust the resolution of a raster to be in exactly the target resolution</span></span>
<span id="cb17-7"><a href="processing.html#cb17-7" tabindex="-1"></a><span class="do">###___________________________________________###</span></span>
<span id="cb17-8"><a href="processing.html#cb17-8" tabindex="-1"></a><span class="cf">if</span>(</span>
<span id="cb17-9"><a href="processing.html#cb17-9" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">file.exists</span>( <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;chm_0.25m.tif&quot;</span>) )</span>
<span id="cb17-10"><a href="processing.html#cb17-10" tabindex="-1"></a>){</span>
<span id="cb17-11"><a href="processing.html#cb17-11" tabindex="-1"></a>  agg_chm_rast <span class="ot">&lt;-</span> cloud2trees<span class="sc">:::</span><span class="fu">adjust_raster_resolution</span>(</span>
<span id="cb17-12"><a href="processing.html#cb17-12" tabindex="-1"></a>    cloud2raster_ans<span class="sc">$</span>chm_rast</span>
<span id="cb17-13"><a href="processing.html#cb17-13" tabindex="-1"></a>    , <span class="at">target_resolution =</span> <span class="fl">0.25</span></span>
<span id="cb17-14"><a href="processing.html#cb17-14" tabindex="-1"></a>    , <span class="at">fun =</span> max</span>
<span id="cb17-15"><a href="processing.html#cb17-15" tabindex="-1"></a>    , <span class="at">resample_method =</span> <span class="st">&quot;max&quot;</span></span>
<span id="cb17-16"><a href="processing.html#cb17-16" tabindex="-1"></a>    , <span class="at">ofile =</span> <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;chm_0.25m.tif&quot;</span>)</span>
<span id="cb17-17"><a href="processing.html#cb17-17" tabindex="-1"></a>  )</span>
<span id="cb17-18"><a href="processing.html#cb17-18" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb17-19"><a href="processing.html#cb17-19" tabindex="-1"></a>  agg_chm_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>( <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;chm_0.25m.tif&quot;</span>) )</span>
<span id="cb17-20"><a href="processing.html#cb17-20" tabindex="-1"></a>}</span>
<span id="cb17-21"><a href="processing.html#cb17-21" tabindex="-1"></a><span class="co"># what chm?</span></span>
<span id="cb17-22"><a href="processing.html#cb17-22" tabindex="-1"></a>agg_chm_rast</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## size        : 10970, 16882, 1  (nrow, ncol, nlyr)
## resolution  : 0.25, 0.25  (x, y)
## extent      : 706698.8, 710919.3, 4191874, 4194616  (xmin, xmax, ymin, ymax)
## coord. ref. : NAD83(2011) / UTM zone 12N (EPSG:6341) 
## source      : chm_0.25m.tif 
## name        : focal_mean 
## min value   :       0.00 
## max value   :      22.59</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="processing.html#cb19-1" tabindex="-1"></a><span class="co"># what data?</span></span>
<span id="cb19-2"><a href="processing.html#cb19-2" tabindex="-1"></a>agg_chm_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    focal_mean   
##  Min.   : 0.02  
##  1st Qu.: 1.91  
##  Median : 3.43  
##  Mean   : 3.37  
##  3rd Qu.: 4.67  
##  Max.   :20.45  
##  NA&#39;s   :72757</code></pre>
</div>
<div id="individial-tree-detection-tuning-itd_tuning" class="section level2 hasAnchor" number="2.3">
<h2><span class="header-section-number">2.3</span> Individial Tree Detection Tuning: <code id="itd">itd_tuning()</code><a href="processing.html#individial-tree-detection-tuning-itd_tuning" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>cloud2trees</code> package performs individual tree detection using <code>lidR::locate_trees()</code> with the <code>lidR::lmf()</code> algorithm. The local maximum filter algorithm allows for a constant window size or a variable window size defined by a function. See the <code>lidR</code> <a href="https://r-lidar.github.io/lidRbook/itd.html">package book section</a> by point cloud processing expert <a href="https://github.com/Jean-Romain">Jean-Romain Roussel</a> for excellent detail on ITD and defining window size.</p>
<p>The <code>itd_tuning()</code> function is used to visually assess tree crown delineation results from different window size functions used for the detection of individual trees. <code>itd_tuning()</code> allows users to test different window size functions on a sample of data to determine which function is most suitable for the area being analyzed. The preferred function can then be used in the <code>ws</code> parameter in <code>raster2trees()</code> and <code>cloud2trees()</code>.</p>
<p>Let’s run <code>itd_tuning()</code> on our CHM data starting with default window size functions</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="processing.html#cb21-1" tabindex="-1"></a><span class="do">###___________________________________________###</span></span>
<span id="cb21-2"><a href="processing.html#cb21-2" tabindex="-1"></a><span class="co"># itd_tuning</span></span>
<span id="cb21-3"><a href="processing.html#cb21-3" tabindex="-1"></a><span class="do">###___________________________________________###</span></span>
<span id="cb21-4"><a href="processing.html#cb21-4" tabindex="-1"></a><span class="co"># run it</span></span>
<span id="cb21-5"><a href="processing.html#cb21-5" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">99</span>)</span>
<span id="cb21-6"><a href="processing.html#cb21-6" tabindex="-1"></a>itd_tuning_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">itd_tuning</span>(</span>
<span id="cb21-7"><a href="processing.html#cb21-7" tabindex="-1"></a>  <span class="at">input_chm_rast =</span> agg_chm_rast</span>
<span id="cb21-8"><a href="processing.html#cb21-8" tabindex="-1"></a>  , <span class="at">min_height =</span> <span class="fl">1.37</span></span>
<span id="cb21-9"><a href="processing.html#cb21-9" tabindex="-1"></a>  , <span class="at">n_samples =</span> <span class="dv">2</span></span>
<span id="cb21-10"><a href="processing.html#cb21-10" tabindex="-1"></a>)</span>
<span id="cb21-11"><a href="processing.html#cb21-11" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb21-12"><a href="processing.html#cb21-12" tabindex="-1"></a>itd_tuning_ans <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span></code></pre></div>
<pre><code>## [1] &quot;plot_samples&quot;        &quot;ws_fn_list&quot;          &quot;plot_sample_summary&quot;
## [4] &quot;crowns&quot;</code></pre>
<p>plot the detected trees on the CHM</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="processing.html#cb23-1" tabindex="-1"></a>itd_tuning_ans<span class="sc">$</span>plot_samples</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-19-1.png" alt="" width="672" /></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="processing.html#cb24-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(</span>
<span id="cb24-2"><a href="processing.html#cb24-2" tabindex="-1"></a>  <span class="at">filename =</span> <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;itd_tuning_plot_samples.jpg&quot;</span>)</span>
<span id="cb24-3"><a href="processing.html#cb24-3" tabindex="-1"></a>  , <span class="at">plot =</span> itd_tuning_ans<span class="sc">$</span>plot_samples</span>
<span id="cb24-4"><a href="processing.html#cb24-4" tabindex="-1"></a>  , <span class="at">height =</span> <span class="dv">7</span>, <span class="at">width =</span> <span class="dv">7</span></span>
<span id="cb24-5"><a href="processing.html#cb24-5" tabindex="-1"></a>  , <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span></span>
<span id="cb24-6"><a href="processing.html#cb24-6" tabindex="-1"></a>)</span></code></pre></div>
<p>plot the summary of the detected trees</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="processing.html#cb25-1" tabindex="-1"></a>itd_tuning_ans<span class="sc">$</span>plot_sample_summary</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-20-1.png" alt="" width="796.8" /></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="processing.html#cb26-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(</span>
<span id="cb26-2"><a href="processing.html#cb26-2" tabindex="-1"></a>  <span class="at">filename =</span> <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;itd_tuning_plot_sample_summary.jpg&quot;</span>)</span>
<span id="cb26-3"><a href="processing.html#cb26-3" tabindex="-1"></a>  , <span class="at">plot =</span> itd_tuning_ans<span class="sc">$</span>plot_sample_summary</span>
<span id="cb26-4"><a href="processing.html#cb26-4" tabindex="-1"></a>  , <span class="at">height =</span> <span class="dv">7</span>, <span class="at">width =</span> <span class="fl">9.5</span></span>
<span id="cb26-5"><a href="processing.html#cb26-5" tabindex="-1"></a>  , <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span></span>
<span id="cb26-6"><a href="processing.html#cb26-6" tabindex="-1"></a>)  </span></code></pre></div>
<p>the <code>exp_fn</code> results in too few trees with crown diameters generally similar to the total tree height which is not expected</p>
<p>check the <code>ws_fn_list</code> return which includes the different window size functions tested</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="processing.html#cb27-1" tabindex="-1"></a><span class="co"># what ws_fn_list</span></span>
<span id="cb27-2"><a href="processing.html#cb27-2" tabindex="-1"></a>itd_tuning_ans<span class="sc">$</span>ws_fn_list <span class="sc">%&gt;%</span> <span class="fu">str</span>()</span></code></pre></div>
<pre><code>## List of 3
##  $ lin_fn:function (x)  
##  $ exp_fn:function (x)  
##  $ log_fn:function (x)</code></pre>
<p>let’s look at the function definition for the linear function (<code>lin_fn</code>)</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="processing.html#cb29-1" tabindex="-1"></a><span class="co"># the linear function</span></span>
<span id="cb29-2"><a href="processing.html#cb29-2" tabindex="-1"></a>itd_tuning_ans<span class="sc">$</span>ws_fn_list<span class="sc">$</span>lin_fn</span></code></pre></div>
<pre><code>## function (x) 
## {
##     y &lt;- dplyr::case_when(is.na(x) ~ 0.001, x &lt; 0 ~ 0.001, x &lt; 
##         2 ~ 1, x &gt; 30 ~ 5, TRUE ~ 0.75 + (x * 0.14))
##     return(y)
## }
## &lt;bytecode: 0x000001c860775b90&gt;
## &lt;environment: 0x000001c860773250&gt;</code></pre>
<p>let’s plot all of the functions we tested with our call to <code>itd_tuning()</code> using the defaults</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="processing.html#cb31-1" tabindex="-1"></a><span class="co"># shape of the ws functions</span></span>
<span id="cb31-2"><a href="processing.html#cb31-2" tabindex="-1"></a>plt_ws_fn <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb31-3"><a href="processing.html#cb31-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_function</span>(<span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> <span class="st">&quot;lin_fn&quot;</span>),<span class="at">fun=</span>itd_tuning_ans<span class="sc">$</span>ws_fn_list<span class="sc">$</span>lin_fn, <span class="at">lwd=</span><span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb31-4"><a href="processing.html#cb31-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_function</span>(<span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> <span class="st">&quot;log_fn&quot;</span>),<span class="at">fun=</span>itd_tuning_ans<span class="sc">$</span>ws_fn_list<span class="sc">$</span>log_fn, <span class="at">lwd=</span><span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb31-5"><a href="processing.html#cb31-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_function</span>(<span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> <span class="st">&quot;exp_fn&quot;</span>),<span class="at">fun=</span>itd_tuning_ans<span class="sc">$</span>ws_fn_list<span class="sc">$</span>exp_fn, <span class="at">lwd=</span><span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb31-6"><a href="processing.html#cb31-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">xlim</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">35</span>) <span class="sc">+</span></span>
<span id="cb31-7"><a href="processing.html#cb31-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>( <span class="at">values =</span> <span class="fu">c</span>(viridis<span class="sc">::</span><span class="fu">viridis</span>(<span class="dv">3</span>), <span class="st">&quot;gray&quot;</span>) ) <span class="sc">+</span></span>
<span id="cb31-8"><a href="processing.html#cb31-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;heights&quot;</span>, <span class="at">y =</span> <span class="st">&quot;ws&quot;</span>, <span class="at">color =</span> <span class="st">&quot;ws function&quot;</span>) <span class="sc">+</span></span>
<span id="cb31-9"><a href="processing.html#cb31-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>()</span>
<span id="cb31-10"><a href="processing.html#cb31-10" tabindex="-1"></a>plt_ws_fn</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-23-1.png" alt="" width="1008" /></p>
<p>Let’s define our own custom linear function that slightly decreases the window size for the shortest trees but increases the window for taller trees compared to the default linear function.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="processing.html#cb32-1" tabindex="-1"></a>my_lin_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb32-2"><a href="processing.html#cb32-2" tabindex="-1"></a>      y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb32-3"><a href="processing.html#cb32-3" tabindex="-1"></a>        <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb32-4"><a href="processing.html#cb32-4" tabindex="-1"></a>        , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb32-5"><a href="processing.html#cb32-5" tabindex="-1"></a>        , x <span class="sc">&gt;</span> (<span class="fl">5.3-0.51</span>)<span class="sc">/</span><span class="fl">0.21</span> <span class="sc">~</span> <span class="fl">5.3</span></span>
<span id="cb32-6"><a href="processing.html#cb32-6" tabindex="-1"></a>        , <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fl">0.51</span> <span class="sc">+</span> (x <span class="sc">*</span> <span class="fl">0.21</span>)</span>
<span id="cb32-7"><a href="processing.html#cb32-7" tabindex="-1"></a>      )</span>
<span id="cb32-8"><a href="processing.html#cb32-8" tabindex="-1"></a>      <span class="fu">return</span>(y)</span>
<span id="cb32-9"><a href="processing.html#cb32-9" tabindex="-1"></a>}</span></code></pre></div>
<p>add to the plot</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="processing.html#cb33-1" tabindex="-1"></a><span class="co"># plt</span></span>
<span id="cb33-2"><a href="processing.html#cb33-2" tabindex="-1"></a>plt_ws_fn <span class="sc">+</span></span>
<span id="cb33-3"><a href="processing.html#cb33-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_function</span>(</span>
<span id="cb33-4"><a href="processing.html#cb33-4" tabindex="-1"></a>    <span class="at">fun =</span> my_lin_fn</span>
<span id="cb33-5"><a href="processing.html#cb33-5" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> <span class="st">&quot;my_lin_fn&quot;</span>)</span>
<span id="cb33-6"><a href="processing.html#cb33-6" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb33-7"><a href="processing.html#cb33-7" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-25-1.png" alt="" width="1008" /></p>
<p>We’ll run another sample test using <code>itd_tuning()</code>with our new function</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="processing.html#cb34-1" tabindex="-1"></a>itd_tuning_ans2 <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">itd_tuning</span>(</span>
<span id="cb34-2"><a href="processing.html#cb34-2" tabindex="-1"></a>  <span class="at">input_chm_rast =</span> agg_chm_rast</span>
<span id="cb34-3"><a href="processing.html#cb34-3" tabindex="-1"></a>  , <span class="at">min_height =</span> <span class="fl">1.37</span></span>
<span id="cb34-4"><a href="processing.html#cb34-4" tabindex="-1"></a>  , <span class="at">ws_fn_list =</span> <span class="fu">list</span>(</span>
<span id="cb34-5"><a href="processing.html#cb34-5" tabindex="-1"></a>    <span class="at">lin_fn =</span> itd_tuning_ans<span class="sc">$</span>ws_fn_list<span class="sc">$</span>lin_fn</span>
<span id="cb34-6"><a href="processing.html#cb34-6" tabindex="-1"></a>    , <span class="at">log_fn =</span> itd_tuning_ans<span class="sc">$</span>ws_fn_list<span class="sc">$</span>log_fn</span>
<span id="cb34-7"><a href="processing.html#cb34-7" tabindex="-1"></a>    , <span class="at">my_lin_fn =</span> my_lin_fn</span>
<span id="cb34-8"><a href="processing.html#cb34-8" tabindex="-1"></a>  )</span>
<span id="cb34-9"><a href="processing.html#cb34-9" tabindex="-1"></a>)</span></code></pre></div>
<p>plot the detected trees on the CHM</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="processing.html#cb35-1" tabindex="-1"></a>itd_tuning_ans2<span class="sc">$</span>plot_samples</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-27-1.png" alt="" width="672" /></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="processing.html#cb36-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(</span>
<span id="cb36-2"><a href="processing.html#cb36-2" tabindex="-1"></a>  <span class="at">filename =</span> <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;itd_tuning_plot_samples2.jpg&quot;</span>)</span>
<span id="cb36-3"><a href="processing.html#cb36-3" tabindex="-1"></a>  , <span class="at">plot =</span> itd_tuning_ans2<span class="sc">$</span>plot_samples</span>
<span id="cb36-4"><a href="processing.html#cb36-4" tabindex="-1"></a>  , <span class="at">height =</span> <span class="dv">7</span>, <span class="at">width =</span> <span class="dv">7</span></span>
<span id="cb36-5"><a href="processing.html#cb36-5" tabindex="-1"></a>  , <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span></span>
<span id="cb36-6"><a href="processing.html#cb36-6" tabindex="-1"></a>)</span></code></pre></div>
<p>plot the summary of the detected trees</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="processing.html#cb37-1" tabindex="-1"></a>itd_tuning_ans2<span class="sc">$</span>plot_sample_summary</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-28-1.png" alt="" width="796.8" /></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="processing.html#cb38-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(</span>
<span id="cb38-2"><a href="processing.html#cb38-2" tabindex="-1"></a>  <span class="at">filename =</span> <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;itd_tuning_plot_sample_summary2.jpg&quot;</span>)</span>
<span id="cb38-3"><a href="processing.html#cb38-3" tabindex="-1"></a>  , <span class="at">plot =</span> itd_tuning_ans2<span class="sc">$</span>plot_sample_summary</span>
<span id="cb38-4"><a href="processing.html#cb38-4" tabindex="-1"></a>  , <span class="at">height =</span> <span class="dv">7</span>, <span class="at">width =</span> <span class="fl">9.5</span></span>
<span id="cb38-5"><a href="processing.html#cb38-5" tabindex="-1"></a>  , <span class="at">dpi =</span> <span class="st">&quot;print&quot;</span></span>
<span id="cb38-6"><a href="processing.html#cb38-6" tabindex="-1"></a>)</span></code></pre></div>
<p>notice, there is also a tree crown data frame in the return</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="processing.html#cb39-1" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb39-2"><a href="processing.html#cb39-2" tabindex="-1"></a>itd_tuning_ans2<span class="sc">$</span>crowns <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 882
## Columns: 9
## $ sample_number    &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ ws_fn            &lt;chr&gt; &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;li…
## $ treeID           &lt;chr&gt; &quot;1_708793.4_4193260.5&quot;, &quot;2_708798.7_4193259.5&quot;, &quot;3_70…
## $ tree_height_m    &lt;dbl&gt; 4.02, 4.83, 2.86, 3.54, 2.83, 3.98, 3.31, 1.48, 3.74,…
## $ tree_x           &lt;dbl&gt; 708793.4, 708798.7, 708810.7, 708813.2, 708811.4, 708…
## $ tree_y           &lt;dbl&gt; 4193260, 4193259, 4193259, 4193259, 4193258, 4193258,…
## $ crown_area_m2    &lt;dbl&gt; 0.8125, 5.1875, 1.1250, 2.3125, 3.6250, 1.5000, 2.312…
## $ geometry         &lt;GEOMETRY [m]&gt; POLYGON ((708793.3 4193261,..., MULTIPOLYGON…
## $ crown_diameter_m &lt;dbl&gt; 2.0155644, 3.1324910, 1.5811388, 2.2360680, 2.9154759…</code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="processing.html#cb41-1" tabindex="-1"></a><span class="co"># count trees by sample</span></span>
<span id="cb41-2"><a href="processing.html#cb41-2" tabindex="-1"></a>itd_tuning_ans2<span class="sc">$</span>crowns <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">count</span>(sample_number, ws_fn)</span></code></pre></div>
<pre><code>## # A tibble: 9 × 3
##   sample_number ws_fn         n
##           &lt;int&gt; &lt;chr&gt;     &lt;int&gt;
## 1             1 lin_fn       79
## 2             1 log_fn       99
## 3             1 my_lin_fn    84
## 4             2 lin_fn       75
## 5             2 log_fn      143
## 6             2 my_lin_fn    89
## 7             3 lin_fn       90
## 8             3 log_fn      127
## 9             3 my_lin_fn    96</code></pre>
<p>with the crowns data we can explore alternative visualizations including overlaying the detected trees on the RGB data if available</p>
<p>read RGB</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="processing.html#cb43-1" tabindex="-1"></a><span class="do">#### read RGB data keep only RGB</span></span>
<span id="cb43-2"><a href="processing.html#cb43-2" tabindex="-1"></a>rgb_rast_fnm <span class="ot">&lt;-</span> <span class="st">&quot;d:/BLM_CO_SWDF_DawsonFuelsTreatment/Final/Ortho/BLM_CO_SWDF_DawsonFuelsTreatment_Ortho_202504.tif&quot;</span></span>
<span id="cb43-3"><a href="processing.html#cb43-3" tabindex="-1"></a>pj_rgb_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(rgb_rast_fnm) <span class="sc">%&gt;%</span> </span>
<span id="cb43-4"><a href="processing.html#cb43-4" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">subset</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>))</span></code></pre></div>
<p>plot it</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="processing.html#cb44-1" tabindex="-1"></a><span class="co"># make a function to plot these detected crowns with rgb data</span></span>
<span id="cb44-2"><a href="processing.html#cb44-2" tabindex="-1"></a>plt_rgb_rast_itd_crowns <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">sample_nmbr =</span> <span class="dv">1</span>, rgb_rast, itd_crowns, <span class="at">plt_lwd =</span> <span class="fl">0.7</span>) {</span>
<span id="cb44-3"><a href="processing.html#cb44-3" tabindex="-1"></a>  <span class="co"># crop</span></span>
<span id="cb44-4"><a href="processing.html#cb44-4" tabindex="-1"></a>  crp_rgb_rast_temp <span class="ot">&lt;-</span> rgb_rast <span class="sc">%&gt;%</span> </span>
<span id="cb44-5"><a href="processing.html#cb44-5" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb44-6"><a href="processing.html#cb44-6" tabindex="-1"></a>      itd_crowns <span class="sc">%&gt;%</span> </span>
<span id="cb44-7"><a href="processing.html#cb44-7" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-8"><a href="processing.html#cb44-8" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_number <span class="sc">==</span> sample_nmbr) <span class="sc">%&gt;%</span> </span>
<span id="cb44-9"><a href="processing.html#cb44-9" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-10"><a href="processing.html#cb44-10" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_bbox</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-11"><a href="processing.html#cb44-11" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-12"><a href="processing.html#cb44-12" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="fl">0.2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-13"><a href="processing.html#cb44-13" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb44-14"><a href="processing.html#cb44-14" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb44-15"><a href="processing.html#cb44-15" tabindex="-1"></a>    )</span>
<span id="cb44-16"><a href="processing.html#cb44-16" tabindex="-1"></a>  <span class="co"># convert raster to a data frame and create hex colors</span></span>
<span id="cb44-17"><a href="processing.html#cb44-17" tabindex="-1"></a>  <span class="co"># ?grDevices::rgb</span></span>
<span id="cb44-18"><a href="processing.html#cb44-18" tabindex="-1"></a>  rgb_df_temp <span class="ot">&lt;-</span></span>
<span id="cb44-19"><a href="processing.html#cb44-19" tabindex="-1"></a>    crp_rgb_rast_temp <span class="sc">%&gt;%</span> </span>
<span id="cb44-20"><a href="processing.html#cb44-20" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-21"><a href="processing.html#cb44-21" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb44-22"><a href="processing.html#cb44-22" tabindex="-1"></a>      <span class="at">red =</span> <span class="dv">3</span>, <span class="at">green =</span> <span class="dv">4</span>, <span class="at">blue =</span> <span class="dv">5</span></span>
<span id="cb44-23"><a href="processing.html#cb44-23" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb44-24"><a href="processing.html#cb44-24" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb44-25"><a href="processing.html#cb44-25" tabindex="-1"></a>      <span class="at">hex_col =</span> grDevices<span class="sc">::</span><span class="fu">rgb</span>(</span>
<span id="cb44-26"><a href="processing.html#cb44-26" tabindex="-1"></a>        red</span>
<span id="cb44-27"><a href="processing.html#cb44-27" tabindex="-1"></a>        , green</span>
<span id="cb44-28"><a href="processing.html#cb44-28" tabindex="-1"></a>        , blue</span>
<span id="cb44-29"><a href="processing.html#cb44-29" tabindex="-1"></a>        , <span class="at">maxColorValue =</span> <span class="dv">255</span></span>
<span id="cb44-30"><a href="processing.html#cb44-30" tabindex="-1"></a>      )</span>
<span id="cb44-31"><a href="processing.html#cb44-31" tabindex="-1"></a>    )</span>
<span id="cb44-32"><a href="processing.html#cb44-32" tabindex="-1"></a>    <span class="co"># dplyr::glimpse()</span></span>
<span id="cb44-33"><a href="processing.html#cb44-33" tabindex="-1"></a>  </span>
<span id="cb44-34"><a href="processing.html#cb44-34" tabindex="-1"></a>  <span class="co"># plt</span></span>
<span id="cb44-35"><a href="processing.html#cb44-35" tabindex="-1"></a>  plt <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb44-36"><a href="processing.html#cb44-36" tabindex="-1"></a>    <span class="co"># add rgb base map</span></span>
<span id="cb44-37"><a href="processing.html#cb44-37" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_raster</span>(<span class="at">data =</span> rgb_df_temp, <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> hex_col)) <span class="sc">+</span></span>
<span id="cb44-38"><a href="processing.html#cb44-38" tabindex="-1"></a>    <span class="co"># use identity scale so the hex codes are used directly</span></span>
<span id="cb44-39"><a href="processing.html#cb44-39" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_identity</span>() <span class="sc">+</span></span>
<span id="cb44-40"><a href="processing.html#cb44-40" tabindex="-1"></a>    <span class="co"># overlay polygons</span></span>
<span id="cb44-41"><a href="processing.html#cb44-41" tabindex="-1"></a>    <span class="co"># ggplot2::geom_sf(data = polys, fill = NA, color = &quot;red&quot;, linewidth = 0.5) +</span></span>
<span id="cb44-42"><a href="processing.html#cb44-42" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb44-43"><a href="processing.html#cb44-43" tabindex="-1"></a>      <span class="at">data =</span> itd_crowns <span class="sc">%&gt;%</span> </span>
<span id="cb44-44"><a href="processing.html#cb44-44" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_number<span class="sc">==</span>sample_nmbr) <span class="sc">%&gt;%</span> </span>
<span id="cb44-45"><a href="processing.html#cb44-45" tabindex="-1"></a>        cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-46"><a href="processing.html#cb44-46" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_make_valid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-47"><a href="processing.html#cb44-47" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_is_valid</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb44-48"><a href="processing.html#cb44-48" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(crp_rgb_rast_temp))</span>
<span id="cb44-49"><a href="processing.html#cb44-49" tabindex="-1"></a>      , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> ws_fn)</span>
<span id="cb44-50"><a href="processing.html#cb44-50" tabindex="-1"></a>      , <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb44-51"><a href="processing.html#cb44-51" tabindex="-1"></a>      , <span class="at">lwd =</span> plt_lwd</span>
<span id="cb44-52"><a href="processing.html#cb44-52" tabindex="-1"></a>      , <span class="at">inherit.aes =</span> F</span>
<span id="cb44-53"><a href="processing.html#cb44-53" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb44-54"><a href="processing.html#cb44-54" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(ws_fn)) <span class="sc">+</span></span>
<span id="cb44-55"><a href="processing.html#cb44-55" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb44-56"><a href="processing.html#cb44-56" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">coord_sf</span>(<span class="at">expand =</span> F) <span class="sc">+</span></span>
<span id="cb44-57"><a href="processing.html#cb44-57" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb44-58"><a href="processing.html#cb44-58" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb44-59"><a href="processing.html#cb44-59" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb44-60"><a href="processing.html#cb44-60" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">margin =</span> ggplot2<span class="sc">::</span><span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">4</span>, <span class="at">b =</span> <span class="dv">4</span>))</span>
<span id="cb44-61"><a href="processing.html#cb44-61" tabindex="-1"></a>      , <span class="at">strip.background =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;gray88&quot;</span>, <span class="at">color =</span> <span class="st">&quot;gray88&quot;</span>)</span>
<span id="cb44-62"><a href="processing.html#cb44-62" tabindex="-1"></a>      , <span class="at">panel.spacing =</span> ggplot2<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">1</span>,<span class="st">&quot;lines&quot;</span>)</span>
<span id="cb44-63"><a href="processing.html#cb44-63" tabindex="-1"></a>    )</span>
<span id="cb44-64"><a href="processing.html#cb44-64" tabindex="-1"></a>  <span class="fu">return</span>(plt)</span>
<span id="cb44-65"><a href="processing.html#cb44-65" tabindex="-1"></a>}</span></code></pre></div>
<p>plot the trees detected in sample one on the RGB</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="processing.html#cb45-1" tabindex="-1"></a><span class="fu">plt_rgb_rast_itd_crowns</span>(<span class="at">sample_nmbr =</span> <span class="dv">1</span>, <span class="at">rgb_rast =</span> pj_rgb_rast, <span class="at">itd_crowns =</span> itd_tuning_ans2<span class="sc">$</span>crowns)</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-32-1.png" alt="" width="691.2" /></p>
<p>this is only moderately helpful as the tree density in tree clumps is difficult to infer from the 2D aerial imagery alone. let’s move forward with the default linear function in the <code>raster2trees()</code> function</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="processing.html#cb46-1" tabindex="-1"></a>my_ws_fn <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">itd_ws_functions</span>()[[<span class="st">&quot;lin_fn&quot;</span>]]</span></code></pre></div>
</div>
<div id="tree-extraction-raster2trees" class="section level2 hasAnchor" number="2.4">
<h2><span class="header-section-number">2.4</span> Tree Extraction: <code id="trees">raster2trees()</code><a href="processing.html#tree-extraction-raster2trees" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now, perform individual tree detection using <code>raster2trees()</code> on the aggregated CHM</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="processing.html#cb47-1" tabindex="-1"></a><span class="do">##############################################################</span></span>
<span id="cb47-2"><a href="processing.html#cb47-2" tabindex="-1"></a><span class="co"># cloud2trees::raster2trees</span></span>
<span id="cb47-3"><a href="processing.html#cb47-3" tabindex="-1"></a><span class="do">##############################################################</span></span>
<span id="cb47-4"><a href="processing.html#cb47-4" tabindex="-1"></a>search_temp <span class="ot">&lt;-</span> cloud2trees<span class="sc">:::</span><span class="fu">search_dir_final_detected</span>(<span class="at">dir =</span> c2t_process_dir)</span>
<span id="cb47-5"><a href="processing.html#cb47-5" tabindex="-1"></a><span class="cf">if</span>(</span>
<span id="cb47-6"><a href="processing.html#cb47-6" tabindex="-1"></a>  <span class="fu">is.null</span>(search_temp<span class="sc">$</span>crowns_flist)</span>
<span id="cb47-7"><a href="processing.html#cb47-7" tabindex="-1"></a>  <span class="sc">||</span> <span class="fu">is.null</span>(search_temp<span class="sc">$</span>ttops_flist)</span>
<span id="cb47-8"><a href="processing.html#cb47-8" tabindex="-1"></a>){</span>
<span id="cb47-9"><a href="processing.html#cb47-9" tabindex="-1"></a>  <span class="co"># time it</span></span>
<span id="cb47-10"><a href="processing.html#cb47-10" tabindex="-1"></a>  st_temp <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb47-11"><a href="processing.html#cb47-11" tabindex="-1"></a>  <span class="co"># run it</span></span>
<span id="cb47-12"><a href="processing.html#cb47-12" tabindex="-1"></a>  <span class="co"># cloud2trees</span></span>
<span id="cb47-13"><a href="processing.html#cb47-13" tabindex="-1"></a>  raster2trees_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">raster2trees</span>(</span>
<span id="cb47-14"><a href="processing.html#cb47-14" tabindex="-1"></a>    <span class="at">chm_rast =</span> agg_chm_rast</span>
<span id="cb47-15"><a href="processing.html#cb47-15" tabindex="-1"></a>    , <span class="at">outfolder =</span> c2t_process_dir</span>
<span id="cb47-16"><a href="processing.html#cb47-16" tabindex="-1"></a>    , <span class="at">ws =</span> my_ws_fn</span>
<span id="cb47-17"><a href="processing.html#cb47-17" tabindex="-1"></a>    , <span class="at">min_height =</span> <span class="fl">1.37</span></span>
<span id="cb47-18"><a href="processing.html#cb47-18" tabindex="-1"></a>    , <span class="at">min_crown_area =</span> <span class="fl">0.5</span></span>
<span id="cb47-19"><a href="processing.html#cb47-19" tabindex="-1"></a>  )</span>
<span id="cb47-20"><a href="processing.html#cb47-20" tabindex="-1"></a>  <span class="co"># raster2trees_ans</span></span>
<span id="cb47-21"><a href="processing.html#cb47-21" tabindex="-1"></a>  <span class="co"># timer</span></span>
<span id="cb47-22"><a href="processing.html#cb47-22" tabindex="-1"></a>  mins_temp <span class="ot">&lt;-</span> <span class="fu">difftime</span>(<span class="fu">Sys.time</span>(),st_temp,<span class="at">units =</span> <span class="st">&quot;mins&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb47-23"><a href="processing.html#cb47-23" tabindex="-1"></a>  <span class="co"># save tracking</span></span>
<span id="cb47-24"><a href="processing.html#cb47-24" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(c2t_tracking_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb47-25"><a href="processing.html#cb47-25" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb47-26"><a href="processing.html#cb47-26" tabindex="-1"></a>      <span class="at">timer_raster2trees_mins =</span> mins_temp</span>
<span id="cb47-27"><a href="processing.html#cb47-27" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb47-28"><a href="processing.html#cb47-28" tabindex="-1"></a>    <span class="fu">write.csv</span>(</span>
<span id="cb47-29"><a href="processing.html#cb47-29" tabindex="-1"></a>      <span class="at">file =</span> c2t_tracking_fnm</span>
<span id="cb47-30"><a href="processing.html#cb47-30" tabindex="-1"></a>      , <span class="at">row.names =</span> F, <span class="at">append =</span> F</span>
<span id="cb47-31"><a href="processing.html#cb47-31" tabindex="-1"></a>    )</span>
<span id="cb47-32"><a href="processing.html#cb47-32" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb47-33"><a href="processing.html#cb47-33" tabindex="-1"></a>  search_dir_final_detected_ans_temp <span class="ot">&lt;-</span> cloud2trees<span class="sc">:::</span><span class="fu">search_dir_final_detected</span>(<span class="at">dir =</span> c2t_process_dir)</span>
<span id="cb47-34"><a href="processing.html#cb47-34" tabindex="-1"></a>  crowns_flist_temp <span class="ot">&lt;-</span> search_dir_final_detected_ans_temp<span class="sc">$</span>crowns_flist</span>
<span id="cb47-35"><a href="processing.html#cb47-35" tabindex="-1"></a>  <span class="co"># read it to get the full list of tree polygons</span></span>
<span id="cb47-36"><a href="processing.html#cb47-36" tabindex="-1"></a>    raster2trees_ans <span class="ot">&lt;-</span> crowns_flist_temp <span class="sc">%&gt;%</span></span>
<span id="cb47-37"><a href="processing.html#cb47-37" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb47-38"><a href="processing.html#cb47-38" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_read</span>(</span>
<span id="cb47-39"><a href="processing.html#cb47-39" tabindex="-1"></a>          <span class="at">dsn =</span> x</span>
<span id="cb47-40"><a href="processing.html#cb47-40" tabindex="-1"></a>          , <span class="at">quiet =</span> T</span>
<span id="cb47-41"><a href="processing.html#cb47-41" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb47-42"><a href="processing.html#cb47-42" tabindex="-1"></a>        <span class="co"># throw in hey_xxxxxxxxxx to test it works if we include non-existant columns</span></span>
<span id="cb47-43"><a href="processing.html#cb47-43" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb47-44"><a href="processing.html#cb47-44" tabindex="-1"></a>          <span class="st">&quot;hey_xxxxxxxxxx&quot;</span></span>
<span id="cb47-45"><a href="processing.html#cb47-45" tabindex="-1"></a>          , <span class="st">&quot;tree_cbh_m&quot;</span></span>
<span id="cb47-46"><a href="processing.html#cb47-46" tabindex="-1"></a>          , <span class="st">&quot;is_training_cbh&quot;</span></span>
<span id="cb47-47"><a href="processing.html#cb47-47" tabindex="-1"></a>        )))</span>
<span id="cb47-48"><a href="processing.html#cb47-48" tabindex="-1"></a>      }) <span class="sc">%&gt;%</span></span>
<span id="cb47-49"><a href="processing.html#cb47-49" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb47-50"><a href="processing.html#cb47-50" tabindex="-1"></a>}</span></code></pre></div>
<p>we should have a spatial tree list with tree height and crown dimensions attached</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="processing.html#cb48-1" tabindex="-1"></a>raster2trees_ans <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 625,378
## Columns: 6
## $ treeID        &lt;chr&gt; &quot;270511_706700.2_4193508&quot;, &quot;273702_706701.7_4193500&quot;, &quot;2…
## $ tree_height_m &lt;dbl&gt; 1.88, 4.37, 2.00, 6.13, 3.21, 4.08, 4.67, 5.79, 2.49, 4.…
## $ tree_x        &lt;dbl&gt; 706700.2, 706701.7, 706702.2, 706702.4, 706703.2, 706703…
## $ tree_y        &lt;dbl&gt; 4193508, 4193500, 4193498, 4193502, 4193468, 4193469, 41…
## $ crown_area_m2 &lt;dbl&gt; 0.5000, 4.6250, 1.1250, 5.7500, 1.5625, 2.8750, 2.3125, …
## $ geom          &lt;MULTIPOLYGON [m]&gt; MULTIPOLYGON (((706700.1 41..., MULTIPOLYGO…</code></pre>
<p>That’s a lot of trees! Let’s plot some on the RGB imagery for the central part of the data. This time, we’ll use <code>terra</code> plotting to demonstrate</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="processing.html#cb50-1" tabindex="-1"></a>aoi_temp <span class="ot">&lt;-</span></span>
<span id="cb50-2"><a href="processing.html#cb50-2" tabindex="-1"></a>  raster2trees_ans <span class="sc">%&gt;%</span> </span>
<span id="cb50-3"><a href="processing.html#cb50-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">prop=</span><span class="fl">0.1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-4"><a href="processing.html#cb50-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_point_on_surface</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-5"><a href="processing.html#cb50-5" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_union</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-6"><a href="processing.html#cb50-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_bbox</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-7"><a href="processing.html#cb50-7" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-8"><a href="processing.html#cb50-8" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-9"><a href="processing.html#cb50-9" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">22</span>, <span class="at">endCapStyle =</span> <span class="st">&quot;SQUARE&quot;</span>)</span>
<span id="cb50-10"><a href="processing.html#cb50-10" tabindex="-1"></a><span class="co"># rgb</span></span>
<span id="cb50-11"><a href="processing.html#cb50-11" tabindex="-1"></a>pj_rgb_rast <span class="sc">%&gt;%</span> </span>
<span id="cb50-12"><a href="processing.html#cb50-12" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">crop</span>(</span>
<span id="cb50-13"><a href="processing.html#cb50-13" tabindex="-1"></a>    aoi_temp <span class="sc">%&gt;%</span></span>
<span id="cb50-14"><a href="processing.html#cb50-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(pj_rgb_rast)) <span class="sc">%&gt;%</span> </span>
<span id="cb50-15"><a href="processing.html#cb50-15" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb50-16"><a href="processing.html#cb50-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb50-17"><a href="processing.html#cb50-17" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plotRGB</span>(<span class="at">stretch =</span> <span class="st">&quot;lin&quot;</span>, <span class="at">axes =</span> F)</span>
<span id="cb50-18"><a href="processing.html#cb50-18" tabindex="-1"></a><span class="co"># trees</span></span>
<span id="cb50-19"><a href="processing.html#cb50-19" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb50-20"><a href="processing.html#cb50-20" tabindex="-1"></a>  raster2trees_ans <span class="sc">%&gt;%</span> </span>
<span id="cb50-21"><a href="processing.html#cb50-21" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb50-22"><a href="processing.html#cb50-22" tabindex="-1"></a>      raster2trees_ans <span class="sc">%&gt;%</span> </span>
<span id="cb50-23"><a href="processing.html#cb50-23" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(</span>
<span id="cb50-24"><a href="processing.html#cb50-24" tabindex="-1"></a>          aoi_temp <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="sc">-</span><span class="dv">2</span>)</span>
<span id="cb50-25"><a href="processing.html#cb50-25" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb50-26"><a href="processing.html#cb50-26" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-27"><a href="processing.html#cb50-27" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(treeID)</span>
<span id="cb50-28"><a href="processing.html#cb50-28" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb50-29"><a href="processing.html#cb50-29" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb50-30"><a href="processing.html#cb50-30" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-31"><a href="processing.html#cb50-31" tabindex="-1"></a>    cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-32"><a href="processing.html#cb50-32" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(pj_rgb_rast)) <span class="sc">%&gt;%</span></span>
<span id="cb50-33"><a href="processing.html#cb50-33" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb50-34"><a href="processing.html#cb50-34" tabindex="-1"></a>  , <span class="at">add =</span> T</span>
<span id="cb50-35"><a href="processing.html#cb50-35" tabindex="-1"></a>  , <span class="at">border =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb50-36"><a href="processing.html#cb50-36" tabindex="-1"></a>)</span></code></pre></div>
<p>That looks like we did a decent job extracting trees. Remember we set a minimum tree height of 1.37 m (DBH) and we may want to filter out small trees as the analysis proceeds. Let’s look at the distribution of tree height in our study area.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="processing.html#cb51-1" tabindex="-1"></a><span class="co"># there are always tree heights</span></span>
<span id="cb51-2"><a href="processing.html#cb51-2" tabindex="-1"></a>raster2trees_ans <span class="sc">%&gt;%</span></span>
<span id="cb51-3"><a href="processing.html#cb51-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> tree_height_m)) <span class="sc">+</span></span>
<span id="cb51-4"><a href="processing.html#cb51-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">&quot;navy&quot;</span>, <span class="at">color =</span> <span class="st">&quot;navy&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb51-5"><a href="processing.html#cb51-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">11</span>)) <span class="sc">+</span></span>
<span id="cb51-6"><a href="processing.html#cb51-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;tree ht. (m)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb51-7"><a href="processing.html#cb51-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb51-8"><a href="processing.html#cb51-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(), <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-40-1.png" alt="" width="1008" /></p>
<p>let’s look at the summary statistics of tree height</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="processing.html#cb52-1" tabindex="-1"></a>raster2trees_ans<span class="sc">$</span>tree_height_m <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.370   2.930   4.120   4.147   5.180  22.590</code></pre>
<p>Notice above we tracked the time it took to process the data. let’s see how long those <code>cloud2trees</code> processing steps took to run. Run times are, of course, dependent on computer processing and I am working on a laptop typical of a spatial analyst (especially outside of the US Federal Government) running Windows with an Intel i7-10750H 6-core computer processor unit and 32 gigabytes of random-access memory.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="processing.html#cb54-1" tabindex="-1"></a><span class="co"># load processing extent</span></span>
<span id="cb54-2"><a href="processing.html#cb54-2" tabindex="-1"></a>raw_las_ctg_info <span class="ot">&lt;-</span> <span class="fu">file.path</span>(c2t_process_dir,<span class="st">&quot;raw_las_ctg_info.gpkg&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-3"><a href="processing.html#cb54-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="at">quiet =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb54-4"><a href="processing.html#cb54-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area_m2 =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>())</span>
<span id="cb54-5"><a href="processing.html#cb54-5" tabindex="-1"></a><span class="co"># load processed_tracking_data.csv</span></span>
<span id="cb54-6"><a href="processing.html#cb54-6" tabindex="-1"></a>processing_data <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(</span>
<span id="cb54-7"><a href="processing.html#cb54-7" tabindex="-1"></a>    <span class="at">file =</span> c2t_tracking_fnm</span>
<span id="cb54-8"><a href="processing.html#cb54-8" tabindex="-1"></a>    , <span class="at">progress =</span> F</span>
<span id="cb54-9"><a href="processing.html#cb54-9" tabindex="-1"></a>    , <span class="at">show_col_types =</span> F</span>
<span id="cb54-10"><a href="processing.html#cb54-10" tabindex="-1"></a>  )</span>
<span id="cb54-11"><a href="processing.html#cb54-11" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb54-12"><a href="processing.html#cb54-12" tabindex="-1"></a>processing_data <span class="sc">%&gt;%</span> </span>
<span id="cb54-13"><a href="processing.html#cb54-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(timer_cloud2raster_mins, timer_raster2trees_mins) <span class="sc">%&gt;%</span></span>
<span id="cb54-14"><a href="processing.html#cb54-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1
## Columns: 2
## $ timer_cloud2raster_mins &lt;dbl&gt; 327.3623
## $ timer_raster2trees_mins &lt;dbl&gt; 13.21568</code></pre>
<p>let’s do some math</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="processing.html#cb56-1" tabindex="-1"></a><span class="co"># total tree extraction time</span></span>
<span id="cb56-2"><a href="processing.html#cb56-2" tabindex="-1"></a>trees_mins_temp <span class="ot">&lt;-</span> processing_data<span class="sc">$</span>timer_cloud2raster_mins[<span class="dv">1</span>] <span class="sc">+</span> </span>
<span id="cb56-3"><a href="processing.html#cb56-3" tabindex="-1"></a>  processing_data<span class="sc">$</span>timer_raster2trees_mins[<span class="dv">1</span>]</span>
<span id="cb56-4"><a href="processing.html#cb56-4" tabindex="-1"></a><span class="co"># ha</span></span>
<span id="cb56-5"><a href="processing.html#cb56-5" tabindex="-1"></a>m2_temp <span class="ot">&lt;-</span> raw_las_ctg_info <span class="sc">%&gt;%</span> </span>
<span id="cb56-6"><a href="processing.html#cb56-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb56-7"><a href="processing.html#cb56-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb56-8"><a href="processing.html#cb56-8" tabindex="-1"></a>    <span class="at">m2 =</span> <span class="fu">sum</span>(area_m2)</span>
<span id="cb56-9"><a href="processing.html#cb56-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-10"><a href="processing.html#cb56-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(m2)</span>
<span id="cb56-11"><a href="processing.html#cb56-11" tabindex="-1"></a><span class="co"># pts</span></span>
<span id="cb56-12"><a href="processing.html#cb56-12" tabindex="-1"></a>pts_temp <span class="ot">&lt;-</span> raw_las_ctg_info <span class="sc">%&gt;%</span> </span>
<span id="cb56-13"><a href="processing.html#cb56-13" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb56-14"><a href="processing.html#cb56-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb56-15"><a href="processing.html#cb56-15" tabindex="-1"></a>    <span class="at">pts =</span> <span class="fu">sum</span>(Number.of.point.records)</span>
<span id="cb56-16"><a href="processing.html#cb56-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-17"><a href="processing.html#cb56-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(pts)</span>
<span id="cb56-18"><a href="processing.html#cb56-18" tabindex="-1"></a><span class="co"># secs per ha</span></span>
<span id="cb56-19"><a href="processing.html#cb56-19" tabindex="-1"></a>rate_temp <span class="ot">&lt;-</span> (trees_mins_temp<span class="sc">*</span><span class="dv">60</span>) <span class="sc">/</span> (m2_temp<span class="sc">/</span><span class="dv">10000</span>)</span>
<span id="cb56-20"><a href="processing.html#cb56-20" tabindex="-1"></a><span class="co"># point density</span></span>
<span id="cb56-21"><a href="processing.html#cb56-21" tabindex="-1"></a>dens_temp <span class="ot">&lt;-</span> pts_temp <span class="sc">/</span> m2_temp</span>
<span id="cb56-22"><a href="processing.html#cb56-22" tabindex="-1"></a><span class="co"># save tracking</span></span>
<span id="cb56-23"><a href="processing.html#cb56-23" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">read_csv</span>(c2t_tracking_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb56-24"><a href="processing.html#cb56-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb56-25"><a href="processing.html#cb56-25" tabindex="-1"></a>    <span class="at">number_of_points =</span> pts_temp</span>
<span id="cb56-26"><a href="processing.html#cb56-26" tabindex="-1"></a>    , <span class="at">las_area_m2 =</span> m2_temp</span>
<span id="cb56-27"><a href="processing.html#cb56-27" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-28"><a href="processing.html#cb56-28" tabindex="-1"></a>  <span class="fu">write.csv</span>(</span>
<span id="cb56-29"><a href="processing.html#cb56-29" tabindex="-1"></a>    <span class="at">file =</span> c2t_tracking_fnm</span>
<span id="cb56-30"><a href="processing.html#cb56-30" tabindex="-1"></a>    , <span class="at">row.names =</span> F, <span class="at">append =</span> F</span>
<span id="cb56-31"><a href="processing.html#cb56-31" tabindex="-1"></a>    )</span></code></pre></div>
<p>Tree extraction over <strong>887.6</strong> hectares took a total of <strong>340.6</strong> minutes at processing rate of <strong>23.02</strong> seconds per hectare on point cloud data with a point density of <strong>590.8</strong> points per square meter (<strong>5,244,072,960</strong> points total).</p>
</div>
<div id="cbh-modeling-trees_cbh" class="section level2 hasAnchor" number="2.5">
<h2><span class="header-section-number">2.5</span> CBH Modeling: <code>trees_cbh()</code><a href="processing.html#cbh-modeling-trees_cbh" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>trees_cbh()</code> function uses the tree crown polygons we <a href="processing.html#trees">delineated from the point cloud</a> with the columns <code>treeID</code> and <code>tree_height_m</code> to attempt to extract crown base height (CBH) directly from the height normalized point cloud using the process outlined in <a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. (2024)</a>.</p>
<p>We’ll attempt to extract CBH for a sample and model the rest based on the data we successfully extracted from the point cloud.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="processing.html#cb57-1" tabindex="-1"></a>cbh_fnm <span class="ot">&lt;-</span> <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;cbh_data.csv&quot;</span>)</span>
<span id="cb57-2"><a href="processing.html#cb57-2" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb57-3"><a href="processing.html#cb57-3" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>( cbh_fnm )){</span>
<span id="cb57-4"><a href="processing.html#cb57-4" tabindex="-1"></a>  <span class="co"># sample proportion</span></span>
<span id="cb57-5"><a href="processing.html#cb57-5" tabindex="-1"></a>  sample_prop_temp <span class="ot">&lt;-</span> <span class="fl">0.10</span></span>
<span id="cb57-6"><a href="processing.html#cb57-6" tabindex="-1"></a>  <span class="co"># time it</span></span>
<span id="cb57-7"><a href="processing.html#cb57-7" tabindex="-1"></a>  st_temp <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb57-8"><a href="processing.html#cb57-8" tabindex="-1"></a>  <span class="co"># run it</span></span>
<span id="cb57-9"><a href="processing.html#cb57-9" tabindex="-1"></a>  trees_cbh_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">trees_cbh</span>(</span>
<span id="cb57-10"><a href="processing.html#cb57-10" tabindex="-1"></a>    <span class="at">trees_poly =</span> c2t_process_dir</span>
<span id="cb57-11"><a href="processing.html#cb57-11" tabindex="-1"></a>    , <span class="at">norm_las =</span> <span class="fu">file.path</span>(c2t_output_dir, <span class="st">&quot;point_cloud_processing_temp&quot;</span>, <span class="st">&quot;02_normalize&quot;</span>)</span>
<span id="cb57-12"><a href="processing.html#cb57-12" tabindex="-1"></a>    , <span class="at">tree_sample_prop =</span> sample_prop_temp</span>
<span id="cb57-13"><a href="processing.html#cb57-13" tabindex="-1"></a>    , <span class="at">which_cbh =</span> <span class="st">&quot;lowest&quot;</span></span>
<span id="cb57-14"><a href="processing.html#cb57-14" tabindex="-1"></a>    , <span class="at">estimate_missing_cbh =</span> <span class="cn">TRUE</span></span>
<span id="cb57-15"><a href="processing.html#cb57-15" tabindex="-1"></a>    , <span class="at">min_vhp_n =</span> <span class="dv">3</span></span>
<span id="cb57-16"><a href="processing.html#cb57-16" tabindex="-1"></a>    , <span class="at">voxel_grain_size_m =</span> <span class="dv">1</span></span>
<span id="cb57-17"><a href="processing.html#cb57-17" tabindex="-1"></a>    , <span class="at">dist_btwn_bins_m =</span> <span class="dv">1</span></span>
<span id="cb57-18"><a href="processing.html#cb57-18" tabindex="-1"></a>    , <span class="at">min_fuel_layer_ht_m =</span> <span class="fl">0.5</span></span>
<span id="cb57-19"><a href="processing.html#cb57-19" tabindex="-1"></a>    , <span class="at">lad_pct_gap =</span> <span class="dv">25</span></span>
<span id="cb57-20"><a href="processing.html#cb57-20" tabindex="-1"></a>    , <span class="at">lad_pct_base =</span> <span class="dv">25</span></span>
<span id="cb57-21"><a href="processing.html#cb57-21" tabindex="-1"></a>    , <span class="at">num_jump_steps =</span> <span class="dv">1</span></span>
<span id="cb57-22"><a href="processing.html#cb57-22" tabindex="-1"></a>    , <span class="at">min_lad_pct =</span> <span class="dv">10</span></span>
<span id="cb57-23"><a href="processing.html#cb57-23" tabindex="-1"></a>    , <span class="at">frst_layer_min_ht_m =</span> <span class="fl">0.5</span></span>
<span id="cb57-24"><a href="processing.html#cb57-24" tabindex="-1"></a>    , <span class="at">force_same_crs =</span> T</span>
<span id="cb57-25"><a href="processing.html#cb57-25" tabindex="-1"></a>  )</span>
<span id="cb57-26"><a href="processing.html#cb57-26" tabindex="-1"></a>  <span class="co"># timer</span></span>
<span id="cb57-27"><a href="processing.html#cb57-27" tabindex="-1"></a>  mins_temp <span class="ot">&lt;-</span> <span class="fu">difftime</span>(<span class="fu">Sys.time</span>(),st_temp,<span class="at">units =</span> <span class="st">&quot;mins&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb57-28"><a href="processing.html#cb57-28" tabindex="-1"></a>  <span class="co"># save cbh</span></span>
<span id="cb57-29"><a href="processing.html#cb57-29" tabindex="-1"></a>  trees_cbh_ans <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb57-30"><a href="processing.html#cb57-30" tabindex="-1"></a>    <span class="fu">write.csv</span>(<span class="at">file =</span> cbh_fnm, <span class="at">row.names =</span> F, <span class="at">append =</span> F)</span>
<span id="cb57-31"><a href="processing.html#cb57-31" tabindex="-1"></a>  <span class="co"># save tracking</span></span>
<span id="cb57-32"><a href="processing.html#cb57-32" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(c2t_tracking_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb57-33"><a href="processing.html#cb57-33" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb57-34"><a href="processing.html#cb57-34" tabindex="-1"></a>      <span class="at">timer_trees_cbh_mins =</span> mins_temp</span>
<span id="cb57-35"><a href="processing.html#cb57-35" tabindex="-1"></a>      , <span class="at">sttng_cbh_tree_sample_n =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)</span>
<span id="cb57-36"><a href="processing.html#cb57-36" tabindex="-1"></a>      , <span class="at">sttng_cbh_tree_sample_prop =</span> sample_prop_temp</span>
<span id="cb57-37"><a href="processing.html#cb57-37" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb57-38"><a href="processing.html#cb57-38" tabindex="-1"></a>    <span class="fu">write.csv</span>(</span>
<span id="cb57-39"><a href="processing.html#cb57-39" tabindex="-1"></a>      <span class="at">file =</span> c2t_tracking_fnm</span>
<span id="cb57-40"><a href="processing.html#cb57-40" tabindex="-1"></a>      , <span class="at">row.names =</span> F, <span class="at">append =</span> F</span>
<span id="cb57-41"><a href="processing.html#cb57-41" tabindex="-1"></a>    )</span>
<span id="cb57-42"><a href="processing.html#cb57-42" tabindex="-1"></a>  </span>
<span id="cb57-43"><a href="processing.html#cb57-43" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb57-44"><a href="processing.html#cb57-44" tabindex="-1"></a>  <span class="co"># cbh data</span></span>
<span id="cb57-45"><a href="processing.html#cb57-45" tabindex="-1"></a>  trees_cbh_ans <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>( cbh_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb57-46"><a href="processing.html#cb57-46" tabindex="-1"></a>}</span></code></pre></div>
<p>CBH extraction took a total of <strong>319.6</strong> minutes (<strong>5.3</strong> hours)</p>
<p>We attempted to extract CBH from 10% of our tree list (62,538 trees), let’s see our success rate</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="processing.html#cb58-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb58-2"><a href="processing.html#cb58-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(is_training_cbh) <span class="sc">%&gt;%</span> </span>
<span id="cb58-3"><a href="processing.html#cb58-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> n<span class="sc">/</span><span class="fu">sum</span>(n))</span></code></pre></div>
<pre><code>## # A tibble: 2 × 3
##   is_training_cbh      n    pct
##   &lt;lgl&gt;            &lt;int&gt;  &lt;dbl&gt;
## 1 FALSE           588400 0.941 
## 2 TRUE             36978 0.0591</code></pre>
<p>That equates to a 59.1% CBH extraction success rate….not a great success ;(</p>
<p>all of the records marked as training data had CBH successfully extracted from the point cloud and were used to estimate a height-CBH allometry relationship that is spatially informed using the relative tree location</p>
<p>let’s look at the training versus the modeled CBH versus height</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="processing.html#cb60-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="processing.html#cb60-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">11111</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb60-3"><a href="processing.html#cb60-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(is_training_cbh) <span class="sc">%&gt;%</span></span>
<span id="cb60-4"><a href="processing.html#cb60-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> tree_height_m, <span class="at">y =</span> tree_cbh_m, <span class="at">color=</span>is_training_cbh)) <span class="sc">+</span> </span>
<span id="cb60-5"><a href="processing.html#cb60-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb60-6"><a href="processing.html#cb60-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;tree ht. (m)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;tree CBH (m)&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-7"><a href="processing.html#cb60-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">extended_breaks</span>(<span class="at">n=</span><span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb60-8"><a href="processing.html#cb60-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">extended_breaks</span>(<span class="at">n=</span><span class="dv">14</span>)) <span class="sc">+</span></span>
<span id="cb60-9"><a href="processing.html#cb60-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">name =</span> <span class="st">&quot;is CBH</span><span class="sc">\n</span><span class="st">from cloud?&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-10"><a href="processing.html#cb60-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>()</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-48-1.png" alt="" width="1008" /></p>
<p>Let’s look at the distribution of CBH in our study area</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="processing.html#cb61-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span></span>
<span id="cb61-2"><a href="processing.html#cb61-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> tree_cbh_m)) <span class="sc">+</span></span>
<span id="cb61-3"><a href="processing.html#cb61-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">&quot;maroon4&quot;</span>, <span class="at">color =</span> <span class="st">&quot;maroon4&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb61-4"><a href="processing.html#cb61-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">11</span>)) <span class="sc">+</span></span>
<span id="cb61-5"><a href="processing.html#cb61-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;tree CBH (m)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb61-6"><a href="processing.html#cb61-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb61-7"><a href="processing.html#cb61-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(), <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-49-1.png" alt="" width="1008" /></p>
<p>and look at the summary statistics of CBH</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="processing.html#cb62-1" tabindex="-1"></a>trees_cbh_ans<span class="sc">$</span>tree_cbh_m <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.223   1.729   2.009   2.023   2.261   8.500</code></pre>
<p>we can also look at the spatial distribution of the trees for which CBH was successfully extracted</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="processing.html#cb64-1" tabindex="-1"></a><span class="co"># convert to pts real quick</span></span>
<span id="cb64-2"><a href="processing.html#cb64-2" tabindex="-1"></a>treetops_sf <span class="ot">&lt;-</span> </span>
<span id="cb64-3"><a href="processing.html#cb64-3" tabindex="-1"></a>  raster2trees_ans <span class="sc">%&gt;%</span> </span>
<span id="cb64-4"><a href="processing.html#cb64-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb64-5"><a href="processing.html#cb64-5" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;tree_x&quot;</span>, <span class="st">&quot;tree_y&quot;</span>), <span class="at">crs =</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(raster2trees_ans), <span class="at">remove =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb64-6"><a href="processing.html#cb64-6" tabindex="-1"></a>  <span class="co"># add on cbh</span></span>
<span id="cb64-7"><a href="processing.html#cb64-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb64-8"><a href="processing.html#cb64-8" tabindex="-1"></a>    trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb64-9"><a href="processing.html#cb64-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, is_training_cbh, tree_cbh_m)</span>
<span id="cb64-10"><a href="processing.html#cb64-10" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb64-11"><a href="processing.html#cb64-11" tabindex="-1"></a>  )</span>
<span id="cb64-12"><a href="processing.html#cb64-12" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb64-13"><a href="processing.html#cb64-13" tabindex="-1"></a>treetops_sf <span class="sc">%&gt;%</span> </span>
<span id="cb64-14"><a href="processing.html#cb64-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">11111</span>, <span class="at">by =</span> is_training_cbh) <span class="sc">%&gt;%</span> </span>
<span id="cb64-15"><a href="processing.html#cb64-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb64-16"><a href="processing.html#cb64-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> is_training_cbh)) <span class="sc">+</span></span>
<span id="cb64-17"><a href="processing.html#cb64-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">name =</span> <span class="st">&quot;is CBH</span><span class="sc">\n</span><span class="st">from cloud?&quot;</span>) <span class="sc">+</span></span>
<span id="cb64-18"><a href="processing.html#cb64-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-51-1.png" alt="" width="1008" /></p>
<p>that is good spatial distribution of the training data</p>
</div>
<div id="dbh-modeling-trees_dbh" class="section level2 hasAnchor" number="2.6">
<h2><span class="header-section-number">2.6</span> DBH Modeling: <code>trees_dbh()</code><a href="processing.html#dbh-modeling-trees_dbh" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>trees_dbh()</code> function uses the <a href="https://www.fs.usda.gov/rds/archive/catalog/RDS-2021-0074">TreeMap</a> FIA plot data in the area of the tree list to estimate the height-DBH allometry relationship. The height predicting DBH model built from the FIA data is then used to predict DBH based on tree height in the tree list.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="processing.html#cb65-1" tabindex="-1"></a>dbh_fnm <span class="ot">&lt;-</span> <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;dbh_data.csv&quot;</span>)</span>
<span id="cb65-2"><a href="processing.html#cb65-2" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb65-3"><a href="processing.html#cb65-3" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>( dbh_fnm )){</span>
<span id="cb65-4"><a href="processing.html#cb65-4" tabindex="-1"></a>  <span class="co"># time it</span></span>
<span id="cb65-5"><a href="processing.html#cb65-5" tabindex="-1"></a>  st_temp <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb65-6"><a href="processing.html#cb65-6" tabindex="-1"></a>  <span class="co"># run it</span></span>
<span id="cb65-7"><a href="processing.html#cb65-7" tabindex="-1"></a>  trees_dbh_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">trees_dbh</span>(</span>
<span id="cb65-8"><a href="processing.html#cb65-8" tabindex="-1"></a>    <span class="at">tree_list =</span> treetops_sf</span>
<span id="cb65-9"><a href="processing.html#cb65-9" tabindex="-1"></a>    , <span class="at">boundary_buffer =</span> <span class="dv">2</span></span>
<span id="cb65-10"><a href="processing.html#cb65-10" tabindex="-1"></a>    , <span class="at">outfolder =</span> c2t_process_dir</span>
<span id="cb65-11"><a href="processing.html#cb65-11" tabindex="-1"></a>  )</span>
<span id="cb65-12"><a href="processing.html#cb65-12" tabindex="-1"></a>  <span class="co"># timer</span></span>
<span id="cb65-13"><a href="processing.html#cb65-13" tabindex="-1"></a>  mins_temp <span class="ot">&lt;-</span> <span class="fu">difftime</span>(<span class="fu">Sys.time</span>(),st_temp,<span class="at">units =</span> <span class="st">&quot;mins&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb65-14"><a href="processing.html#cb65-14" tabindex="-1"></a>  <span class="co"># save dbh</span></span>
<span id="cb65-15"><a href="processing.html#cb65-15" tabindex="-1"></a>  trees_dbh_ans <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb65-16"><a href="processing.html#cb65-16" tabindex="-1"></a>    <span class="fu">write.csv</span>(<span class="at">file =</span> dbh_fnm, <span class="at">row.names =</span> F, <span class="at">append =</span> F)</span>
<span id="cb65-17"><a href="processing.html#cb65-17" tabindex="-1"></a>  <span class="co"># save tracking</span></span>
<span id="cb65-18"><a href="processing.html#cb65-18" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(c2t_tracking_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb65-19"><a href="processing.html#cb65-19" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb65-20"><a href="processing.html#cb65-20" tabindex="-1"></a>      <span class="at">timer_trees_dbh_mins =</span> mins_temp</span>
<span id="cb65-21"><a href="processing.html#cb65-21" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb65-22"><a href="processing.html#cb65-22" tabindex="-1"></a>    <span class="fu">write.csv</span>(</span>
<span id="cb65-23"><a href="processing.html#cb65-23" tabindex="-1"></a>      <span class="at">file =</span> c2t_tracking_fnm</span>
<span id="cb65-24"><a href="processing.html#cb65-24" tabindex="-1"></a>      , <span class="at">row.names =</span> F, <span class="at">append =</span> F</span>
<span id="cb65-25"><a href="processing.html#cb65-25" tabindex="-1"></a>    )</span>
<span id="cb65-26"><a href="processing.html#cb65-26" tabindex="-1"></a>  </span>
<span id="cb65-27"><a href="processing.html#cb65-27" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb65-28"><a href="processing.html#cb65-28" tabindex="-1"></a>  <span class="co"># dbh data</span></span>
<span id="cb65-29"><a href="processing.html#cb65-29" tabindex="-1"></a>  trees_dbh_ans <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>( dbh_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb65-30"><a href="processing.html#cb65-30" tabindex="-1"></a>}</span></code></pre></div>
<p>Estimating DBH for our tree list of <strong>625,378</strong> trees took <strong>7.9</strong> minutes</p>
<p>let’s check the relationship between height and DBH as estimated by the regional allometric relationship</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="processing.html#cb66-1" tabindex="-1"></a>trees_dbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb66-2"><a href="processing.html#cb66-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">7777</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb66-3"><a href="processing.html#cb66-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> tree_height_m, <span class="at">y =</span> dbh_cm)) <span class="sc">+</span> </span>
<span id="cb66-4"><a href="processing.html#cb66-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">&quot;navy&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb66-5"><a href="processing.html#cb66-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;tree ht. (m)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;tree DBH (cm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb66-6"><a href="processing.html#cb66-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb66-7"><a href="processing.html#cb66-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb66-8"><a href="processing.html#cb66-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>()</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-55-1.png" alt="" width="1008" /></p>
<p>Let’s look at the distribution of tree diameter in our study area</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="processing.html#cb67-1" tabindex="-1"></a>trees_dbh_ans <span class="sc">%&gt;%</span></span>
<span id="cb67-2"><a href="processing.html#cb67-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> dbh_cm)) <span class="sc">+</span></span>
<span id="cb67-3"><a href="processing.html#cb67-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">color =</span> <span class="st">&quot;brown&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb67-4"><a href="processing.html#cb67-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">11</span>)) <span class="sc">+</span></span>
<span id="cb67-5"><a href="processing.html#cb67-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;tree DBH (cm)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb67-6"><a href="processing.html#cb67-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb67-7"><a href="processing.html#cb67-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(), <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-56-1.png" alt="" width="1008" /></p>
<p>let’s look at the summary statistics</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="processing.html#cb68-1" tabindex="-1"></a>trees_dbh_ans<span class="sc">$</span>dbh_cm <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   4.584  14.756  23.626  22.551  30.043  41.932</code></pre>
<p><code>cloud2trees::trees_dbh()</code> saved the actual model estimated using the Bayesian modelling package <code>brms</code> which we can load and review</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="processing.html#cb70-1" tabindex="-1"></a>dbh_mod_temp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>( <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;regional_dbh_height_model.rds&quot;</span>) )</span>
<span id="cb70-2"><a href="processing.html#cb70-2" tabindex="-1"></a><span class="co"># what is this?</span></span>
<span id="cb70-3"><a href="processing.html#cb70-3" tabindex="-1"></a>dbh_mod_temp <span class="sc">%&gt;%</span> <span class="fu">class</span>()</span></code></pre></div>
<pre><code>## [1] &quot;brmsfit&quot;</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="processing.html#cb72-1" tabindex="-1"></a><span class="co"># model formula</span></span>
<span id="cb72-2"><a href="processing.html#cb72-2" tabindex="-1"></a>dbh_mod_temp</span></code></pre></div>
<pre><code>##  Family: lognormal 
##   Links: mu = identity 
## Formula: dbh_cm | weights(tree_weight) ~ asym * (1 - exp(-k * tree_height_m))^p 
##          asym ~ 1
##          k ~ 1
##          p ~ 1
##    Data: treemap_trees_df (Number of observations: 2386) 
##   Draws: 4 chains, each with iter = 6000; warmup = 3000; thin = 1;
##          total post-warmup draws = 12000
## 
## Regression Coefficients:
##                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## asym_Intercept     3.63      0.00     3.62     3.63 1.00     3015     4147
## k_Intercept        0.54      0.00     0.53     0.54 1.00     2233     2941
## p_Intercept        1.44      0.01     1.42     1.45 1.00     2275     3064
## 
## Further Distributional Parameters:
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.44      0.00     0.44     0.44 1.00     5531     5420
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>we can draw fit curves with probability bands using the <code>tidybayes</code> package</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="processing.html#cb74-1" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb74-2"><a href="processing.html#cb74-2" tabindex="-1"></a><span class="co"># define our height range to predict over</span></span>
<span id="cb74-3"><a href="processing.html#cb74-3" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">tree_height_m =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">30</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb74-4"><a href="processing.html#cb74-4" tabindex="-1"></a>  tidybayes<span class="sc">::</span><span class="fu">add_epred_draws</span>(dbh_mod_temp, <span class="at">ndraws =</span> <span class="dv">2000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb74-5"><a href="processing.html#cb74-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> tree_height_m)) <span class="sc">+</span></span>
<span id="cb74-6"><a href="processing.html#cb74-6" tabindex="-1"></a>    tidybayes<span class="sc">::</span><span class="fu">stat_lineribbon</span>(</span>
<span id="cb74-7"><a href="processing.html#cb74-7" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y =</span> .epred, <span class="at">color =</span> <span class="st">&quot;estimate&quot;</span>)</span>
<span id="cb74-8"><a href="processing.html#cb74-8" tabindex="-1"></a>      , <span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">0.95</span>)</span>
<span id="cb74-9"><a href="processing.html#cb74-9" tabindex="-1"></a>      , <span class="at">lwd =</span> <span class="fl">0.6</span></span>
<span id="cb74-10"><a href="processing.html#cb74-10" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb74-11"><a href="processing.html#cb74-11" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">&quot;Oranges&quot;</span>) <span class="sc">+</span></span>
<span id="cb74-12"><a href="processing.html#cb74-12" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;gray33&quot;</span>)) <span class="sc">+</span></span>
<span id="cb74-13"><a href="processing.html#cb74-13" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;tree ht. (m)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;est. tree DBH (cm)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb74-14"><a href="processing.html#cb74-14" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">extended_breaks</span>(<span class="at">n=</span><span class="dv">11</span>)) <span class="sc">+</span></span>
<span id="cb74-15"><a href="processing.html#cb74-15" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">extended_breaks</span>(<span class="at">n=</span><span class="dv">11</span>)) <span class="sc">+</span></span>
<span id="cb74-16"><a href="processing.html#cb74-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>()</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-60-1.png" alt="" width="1008" /></p>
<p>The probability bands are there in shades of orange but they are so tight to the median estimate that it’s difficult to see them. The model confidence bands are so narrow because the model was trained with lots of FIA measured trees over the broad study area</p>
<p>we can check how many FIA measured trees were used to train our model because <code>cloud2trees::trees_dbh()</code> also writes the training data to the disk (that’s neat, but we don’t always need to see how the sausage is made)</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="processing.html#cb75-1" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">read_csv</span>(</span>
<span id="cb75-2"><a href="processing.html#cb75-2" tabindex="-1"></a>    <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;regional_dbh_height_model_training_data.csv&quot;</span>)</span>
<span id="cb75-3"><a href="processing.html#cb75-3" tabindex="-1"></a>    , <span class="at">progress =</span> F</span>
<span id="cb75-4"><a href="processing.html#cb75-4" tabindex="-1"></a>    , <span class="at">show_col_types =</span> F</span>
<span id="cb75-5"><a href="processing.html#cb75-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb75-6"><a href="processing.html#cb75-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">training_trees =</span> <span class="fu">sum</span>(tree_weight)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-7"><a href="processing.html#cb75-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(training_trees) <span class="sc">%&gt;%</span> </span>
<span id="cb75-8"><a href="processing.html#cb75-8" tabindex="-1"></a>  scales<span class="sc">::</span><span class="fu">comma</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] &quot;331,111&quot;</code></pre>
<p>that’s how many FIA measured trees were used to train our model</p>
</div>
<div id="hmd-modeling-trees_hmd" class="section level2 hasAnchor" number="2.7">
<h2><span class="header-section-number">2.7</span> HMD Modeling: <code>trees_hmd()</code><a href="processing.html#hmd-modeling-trees_hmd" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>trees_hmd()</code> function uses the tree crown polygons we <a href="processing.html#trees">delineated from the point cloud</a> with the columns <code>treeID</code> and <code>tree_height_m</code> to attempt to extract height to maximum crown diameter (HMD) directly from the height normalized point cloud by finding the height of the non-ground point farthest from the tree center (i.e. tree top). HMD refers to the vertical height at which a tree’s crown has its widest horizontal spread. It describes a characteristic of the overall crown shape and structure.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="processing.html#cb77-1" tabindex="-1"></a>hmd_fnm <span class="ot">&lt;-</span> <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;hmd_data.csv&quot;</span>)</span>
<span id="cb77-2"><a href="processing.html#cb77-2" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb77-3"><a href="processing.html#cb77-3" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>( hmd_fnm )){</span>
<span id="cb77-4"><a href="processing.html#cb77-4" tabindex="-1"></a>  <span class="co"># sample proportion</span></span>
<span id="cb77-5"><a href="processing.html#cb77-5" tabindex="-1"></a>  sample_prop_temp <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)</span>
<span id="cb77-6"><a href="processing.html#cb77-6" tabindex="-1"></a>  <span class="co"># time it</span></span>
<span id="cb77-7"><a href="processing.html#cb77-7" tabindex="-1"></a>  st_temp <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb77-8"><a href="processing.html#cb77-8" tabindex="-1"></a>  <span class="co"># run it</span></span>
<span id="cb77-9"><a href="processing.html#cb77-9" tabindex="-1"></a>  trees_hmd_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">trees_hmd</span>(</span>
<span id="cb77-10"><a href="processing.html#cb77-10" tabindex="-1"></a>    <span class="at">trees_poly =</span> c2t_process_dir</span>
<span id="cb77-11"><a href="processing.html#cb77-11" tabindex="-1"></a>    , <span class="at">norm_las =</span> <span class="fu">file.path</span>(c2t_output_dir, <span class="st">&quot;point_cloud_processing_temp&quot;</span>, <span class="st">&quot;02_normalize&quot;</span>)</span>
<span id="cb77-12"><a href="processing.html#cb77-12" tabindex="-1"></a>    , <span class="at">tree_sample_prop =</span> sample_prop_temp</span>
<span id="cb77-13"><a href="processing.html#cb77-13" tabindex="-1"></a>    , <span class="at">force_same_crs =</span> T</span>
<span id="cb77-14"><a href="processing.html#cb77-14" tabindex="-1"></a>    , <span class="at">estimate_missing_hmd =</span> T</span>
<span id="cb77-15"><a href="processing.html#cb77-15" tabindex="-1"></a>  )</span>
<span id="cb77-16"><a href="processing.html#cb77-16" tabindex="-1"></a>  <span class="co"># timer</span></span>
<span id="cb77-17"><a href="processing.html#cb77-17" tabindex="-1"></a>  mins_temp <span class="ot">&lt;-</span> <span class="fu">difftime</span>(<span class="fu">Sys.time</span>(),st_temp,<span class="at">units =</span> <span class="st">&quot;mins&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb77-18"><a href="processing.html#cb77-18" tabindex="-1"></a>  <span class="co"># save hmd</span></span>
<span id="cb77-19"><a href="processing.html#cb77-19" tabindex="-1"></a>  trees_hmd_ans <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb77-20"><a href="processing.html#cb77-20" tabindex="-1"></a>    <span class="fu">write.csv</span>(<span class="at">file =</span> hmd_fnm, <span class="at">row.names =</span> F, <span class="at">append =</span> F)</span>
<span id="cb77-21"><a href="processing.html#cb77-21" tabindex="-1"></a>  <span class="co"># save tracking</span></span>
<span id="cb77-22"><a href="processing.html#cb77-22" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(c2t_tracking_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb77-23"><a href="processing.html#cb77-23" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb77-24"><a href="processing.html#cb77-24" tabindex="-1"></a>      <span class="at">timer_trees_hmd_mins =</span> mins_temp</span>
<span id="cb77-25"><a href="processing.html#cb77-25" tabindex="-1"></a>      , <span class="at">sttng_hmd_tree_sample_n =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)</span>
<span id="cb77-26"><a href="processing.html#cb77-26" tabindex="-1"></a>      , <span class="at">sttng_hmd_tree_sample_prop =</span> sample_prop_temp</span>
<span id="cb77-27"><a href="processing.html#cb77-27" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb77-28"><a href="processing.html#cb77-28" tabindex="-1"></a>    <span class="fu">write.csv</span>(</span>
<span id="cb77-29"><a href="processing.html#cb77-29" tabindex="-1"></a>      <span class="at">file =</span> c2t_tracking_fnm</span>
<span id="cb77-30"><a href="processing.html#cb77-30" tabindex="-1"></a>      , <span class="at">row.names =</span> F, <span class="at">append =</span> F</span>
<span id="cb77-31"><a href="processing.html#cb77-31" tabindex="-1"></a>    )</span>
<span id="cb77-32"><a href="processing.html#cb77-32" tabindex="-1"></a>  </span>
<span id="cb77-33"><a href="processing.html#cb77-33" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb77-34"><a href="processing.html#cb77-34" tabindex="-1"></a>  <span class="co"># hmd data</span></span>
<span id="cb77-35"><a href="processing.html#cb77-35" tabindex="-1"></a>  trees_hmd_ans <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>( hmd_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb77-36"><a href="processing.html#cb77-36" tabindex="-1"></a>}</span></code></pre></div>
<p>HMD extraction took a total of <strong>203.5</strong> minutes at processing rate of <strong>19.53</strong> seconds per 1,000 trees</p>
<p>We attempted to extract HMD from 33% of our tree list, let’s see our success rate</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="processing.html#cb78-1" tabindex="-1"></a>trees_hmd_ans <span class="sc">%&gt;%</span> </span>
<span id="cb78-2"><a href="processing.html#cb78-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb78-3"><a href="processing.html#cb78-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(is_training_hmd) <span class="sc">%&gt;%</span> </span>
<span id="cb78-4"><a href="processing.html#cb78-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> n<span class="sc">/</span><span class="fu">sum</span>(n))</span></code></pre></div>
<pre><code>## # A tibble: 2 × 3
##   is_training_hmd      n   pct
##   &lt;lgl&gt;            &lt;int&gt; &lt;dbl&gt;
## 1 FALSE           447306 0.715
## 2 TRUE            178072 0.285</code></pre>
<p>all of the records marked as “training data” had HMD successfully extracted from the point cloud and were used to estimate a height-HMD allometry relationship that is spatially informed using the relative tree location</p>
<p>let’s look at the training versus the modeled HMD versus height</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="processing.html#cb80-1" tabindex="-1"></a>trees_hmd_ans <span class="sc">%&gt;%</span> </span>
<span id="cb80-2"><a href="processing.html#cb80-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">11111</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb80-3"><a href="processing.html#cb80-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(is_training_hmd)) <span class="sc">%&gt;%</span></span>
<span id="cb80-4"><a href="processing.html#cb80-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> tree_height_m, <span class="at">y =</span> max_crown_diam_height_m, <span class="at">color=</span>is_training_hmd)) <span class="sc">+</span> </span>
<span id="cb80-5"><a href="processing.html#cb80-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb80-6"><a href="processing.html#cb80-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;tree ht. (m)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;tree HMD (m)&quot;</span>) <span class="sc">+</span></span>
<span id="cb80-7"><a href="processing.html#cb80-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">extended_breaks</span>(<span class="at">n=</span><span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb80-8"><a href="processing.html#cb80-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">extended_breaks</span>(<span class="at">n=</span><span class="dv">14</span>)) <span class="sc">+</span></span>
<span id="cb80-9"><a href="processing.html#cb80-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;magma&quot;</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">name =</span> <span class="st">&quot;is HMD</span><span class="sc">\n</span><span class="st">from cloud?&quot;</span>) <span class="sc">+</span></span>
<span id="cb80-10"><a href="processing.html#cb80-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>()</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-66-1.png" alt="" width="1008" /></p>
<p>Let’s look at the distribution of HMD in our study area</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="processing.html#cb81-1" tabindex="-1"></a>trees_hmd_ans <span class="sc">%&gt;%</span></span>
<span id="cb81-2"><a href="processing.html#cb81-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> max_crown_diam_height_m)) <span class="sc">+</span></span>
<span id="cb81-3"><a href="processing.html#cb81-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">&quot;coral&quot;</span>, <span class="at">color =</span> <span class="st">&quot;coral&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb81-4"><a href="processing.html#cb81-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">11</span>)) <span class="sc">+</span></span>
<span id="cb81-5"><a href="processing.html#cb81-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;tree HMD (m)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb81-6"><a href="processing.html#cb81-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb81-7"><a href="processing.html#cb81-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(), <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-67-1.png" alt="" width="1008" /></p>
<p>and look at the summary statistics of HMD</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="processing.html#cb82-1" tabindex="-1"></a>trees_hmd_ans<span class="sc">$</span>max_crown_diam_height_m <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   0.000   1.259   1.766   1.752   2.127   9.360</code></pre>
</div>
<div id="forest-type-trees_type" class="section level2 hasAnchor" number="2.8">
<h2><span class="header-section-number">2.8</span> Forest Type: <code id="trees_type">trees_type()</code><a href="processing.html#forest-type-trees_type" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We’ll now use <code>trees_type()</code> to attach species information using USDA Forest Inventory and Analysis (FIA) codes. FIA Forest Type Group Code is attached to each tree in the tree list based on the spatial overlap with the <a href="https://www.arcgis.com/home/item.html?id=10760c83b9e44923bd3c18efdaa7319d">Forest Type Groups of the Continental United States</a> data (Wilson 2023).</p>
<p>let’s get the FIA forest type group for our tree list</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="processing.html#cb84-1" tabindex="-1"></a><span class="co"># where should we save the file?</span></span>
<span id="cb84-2"><a href="processing.html#cb84-2" tabindex="-1"></a>type_fnm <span class="ot">&lt;-</span> <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;type_data.csv&quot;</span>)</span>
<span id="cb84-3"><a href="processing.html#cb84-3" tabindex="-1"></a>type_rast_fnm <span class="ot">&lt;-</span> <span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;type_rast.tif&quot;</span>)</span>
<span id="cb84-4"><a href="processing.html#cb84-4" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb84-5"><a href="processing.html#cb84-5" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(type_fnm) <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(type_rast_fnm)){</span>
<span id="cb84-6"><a href="processing.html#cb84-6" tabindex="-1"></a>  <span class="co"># time it</span></span>
<span id="cb84-7"><a href="processing.html#cb84-7" tabindex="-1"></a>  st_temp <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb84-8"><a href="processing.html#cb84-8" tabindex="-1"></a>  <span class="co"># run it</span></span>
<span id="cb84-9"><a href="processing.html#cb84-9" tabindex="-1"></a>  trees_type_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">trees_type</span>(</span>
<span id="cb84-10"><a href="processing.html#cb84-10" tabindex="-1"></a>    <span class="at">tree_list =</span> treetops_sf</span>
<span id="cb84-11"><a href="processing.html#cb84-11" tabindex="-1"></a>    , <span class="at">study_boundary =</span> </span>
<span id="cb84-12"><a href="processing.html#cb84-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;raw_las_ctg_info.gpkg&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb84-13"><a href="processing.html#cb84-13" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_union</span>()</span>
<span id="cb84-14"><a href="processing.html#cb84-14" tabindex="-1"></a>  )</span>
<span id="cb84-15"><a href="processing.html#cb84-15" tabindex="-1"></a>  <span class="co"># timer</span></span>
<span id="cb84-16"><a href="processing.html#cb84-16" tabindex="-1"></a>  mins_temp <span class="ot">&lt;-</span> <span class="fu">difftime</span>(<span class="fu">Sys.time</span>(),st_temp,<span class="at">units =</span> <span class="st">&quot;mins&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb84-17"><a href="processing.html#cb84-17" tabindex="-1"></a>  <span class="co"># save type</span></span>
<span id="cb84-18"><a href="processing.html#cb84-18" tabindex="-1"></a>  trees_type_ans<span class="sc">$</span>tree_list <span class="sc">%&gt;%</span> </span>
<span id="cb84-19"><a href="processing.html#cb84-19" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb84-20"><a href="processing.html#cb84-20" tabindex="-1"></a>    <span class="fu">write.csv</span>(<span class="at">file =</span> type_fnm, <span class="at">row.names =</span> F, <span class="at">append =</span> F)</span>
<span id="cb84-21"><a href="processing.html#cb84-21" tabindex="-1"></a>  <span class="co"># save raster</span></span>
<span id="cb84-22"><a href="processing.html#cb84-22" tabindex="-1"></a>  trees_type_ans<span class="sc">$</span>foresttype_rast <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">writeRaster</span>(type_rast_fnm, <span class="at">overwrite=</span>T)</span>
<span id="cb84-23"><a href="processing.html#cb84-23" tabindex="-1"></a>  <span class="co"># save tracking</span></span>
<span id="cb84-24"><a href="processing.html#cb84-24" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(c2t_tracking_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb84-25"><a href="processing.html#cb84-25" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb84-26"><a href="processing.html#cb84-26" tabindex="-1"></a>      <span class="at">timer_trees_type_mins =</span> mins_temp</span>
<span id="cb84-27"><a href="processing.html#cb84-27" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb84-28"><a href="processing.html#cb84-28" tabindex="-1"></a>    <span class="fu">write.csv</span>(</span>
<span id="cb84-29"><a href="processing.html#cb84-29" tabindex="-1"></a>      <span class="at">file =</span> c2t_tracking_fnm</span>
<span id="cb84-30"><a href="processing.html#cb84-30" tabindex="-1"></a>      , <span class="at">row.names =</span> F, <span class="at">append =</span> F</span>
<span id="cb84-31"><a href="processing.html#cb84-31" tabindex="-1"></a>    )</span>
<span id="cb84-32"><a href="processing.html#cb84-32" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb84-33"><a href="processing.html#cb84-33" tabindex="-1"></a>  trees_type_ans <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb84-34"><a href="processing.html#cb84-34" tabindex="-1"></a>  <span class="co"># type data</span></span>
<span id="cb84-35"><a href="processing.html#cb84-35" tabindex="-1"></a>  trees_type_ans<span class="sc">$</span>tree_list <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(type_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb84-36"><a href="processing.html#cb84-36" tabindex="-1"></a>  <span class="co"># raster</span></span>
<span id="cb84-37"><a href="processing.html#cb84-37" tabindex="-1"></a>  trees_type_ans<span class="sc">$</span>foresttype_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(type_rast_fnm)</span>
<span id="cb84-38"><a href="processing.html#cb84-38" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s look at the FIA Forest Type Group data we extracted for the tree list.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="processing.html#cb85-1" tabindex="-1"></a>trees_type_ans<span class="sc">$</span>tree_list <span class="sc">%&gt;%</span></span>
<span id="cb85-2"><a href="processing.html#cb85-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb85-3"><a href="processing.html#cb85-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(forest_type_group_code, forest_type_group) <span class="sc">%&gt;%</span> </span>
<span id="cb85-4"><a href="processing.html#cb85-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb85-5"><a href="processing.html#cb85-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb85-6"><a href="processing.html#cb85-6" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">&quot;Count of trees by FIA Forest Type Group&quot;</span>, <span class="at">digits =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb85-7"><a href="processing.html#cb85-7" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-71">Table 2.1: </span>Count of trees by FIA Forest Type Group
</caption>
<thead>
<tr>
<th style="text-align:right;">
forest_type_group_code
</th>
<th style="text-align:left;">
forest_type_group
</th>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
pct
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
180
</td>
<td style="text-align:left;">
Pinyon / juniper group
</td>
<td style="text-align:right;">
605364
</td>
<td style="text-align:right;">
0.97
</td>
</tr>
<tr>
<td style="text-align:right;">
220
</td>
<td style="text-align:left;">
Ponderosa pine group
</td>
<td style="text-align:right;">
19879
</td>
<td style="text-align:right;">
0.03
</td>
</tr>
<tr>
<td style="text-align:right;">
970
</td>
<td style="text-align:left;">
Woodland hardwoods group
</td>
<td style="text-align:right;">
135
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
</tbody>
</table>
<p>Let’s attach FIA Forest Types Group name to the raster (<code>foresttype_rast</code>) of the area we searched and plot it</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="processing.html#cb86-1" tabindex="-1"></a><span class="co"># load in the forest type data</span></span>
<span id="cb86-2"><a href="processing.html#cb86-2" tabindex="-1"></a>ext_data_temp <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">find_ext_data</span>()</span>
<span id="cb86-3"><a href="processing.html#cb86-3" tabindex="-1"></a>foresttype_lookup <span class="ot">&lt;-</span> <span class="fu">file.path</span>(ext_data_temp<span class="sc">$</span>foresttype_dir, <span class="st">&quot;foresttype_lookup.csv&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb86-4"><a href="processing.html#cb86-4" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="at">progress =</span> F, <span class="at">show_col_types =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb86-5"><a href="processing.html#cb86-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>(forest_type_group_code, forest_type_group, hardwood_softwood)</span>
<span id="cb86-6"><a href="processing.html#cb86-6" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb86-7"><a href="processing.html#cb86-7" tabindex="-1"></a>foresttype_lookup <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 35
## Columns: 3
## $ forest_type_group_code &lt;dbl&gt; 100, 120, 140, 150, 160, 170, 180, 200, 220, 24…
## $ forest_type_group      &lt;chr&gt; &quot;White / red / jack pine group&quot;, &quot;Spruce / fir …
## $ hardwood_softwood      &lt;chr&gt; &quot;Softwood&quot;, &quot;Softwood&quot;, &quot;Softwood&quot;, &quot;Softwood&quot;,…</code></pre>
<p>plot the FIA Forest Types Group raster within the footprint of the point cloud data we processed</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="processing.html#cb88-1" tabindex="-1"></a><span class="co"># study area</span></span>
<span id="cb88-2"><a href="processing.html#cb88-2" tabindex="-1"></a>aoi_temp <span class="ot">&lt;-</span> </span>
<span id="cb88-3"><a href="processing.html#cb88-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(c2t_process_dir, <span class="st">&quot;raw_las_ctg_info.gpkg&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb88-4"><a href="processing.html#cb88-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(trees_type_ans<span class="sc">$</span>foresttype_rast))</span>
<span id="cb88-5"><a href="processing.html#cb88-5" tabindex="-1"></a><span class="co"># plot raster</span></span>
<span id="cb88-6"><a href="processing.html#cb88-6" tabindex="-1"></a>r_plt <span class="ot">&lt;-</span></span>
<span id="cb88-7"><a href="processing.html#cb88-7" tabindex="-1"></a>  trees_type_ans<span class="sc">$</span>foresttype_rast <span class="sc">%&gt;%</span></span>
<span id="cb88-8"><a href="processing.html#cb88-8" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">crop</span>(aoi_temp <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">5</span>) <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb88-9"><a href="processing.html#cb88-9" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb88-10"><a href="processing.html#cb88-10" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">forest_type_group_code =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb88-11"><a href="processing.html#cb88-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(foresttype_lookup, <span class="at">by =</span> <span class="st">&quot;forest_type_group_code&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb88-12"><a href="processing.html#cb88-12" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb88-13"><a href="processing.html#cb88-13" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">fill =</span> forest_type_group)) <span class="sc">+</span></span>
<span id="cb88-14"><a href="processing.html#cb88-14" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;FIA forest</span><span class="sc">\n</span><span class="st">type group&quot;</span>) <span class="sc">+</span></span>
<span id="cb88-15"><a href="processing.html#cb88-15" tabindex="-1"></a>    <span class="co"># ggplot2::scale_fill_viridis_d(option = &quot;turbo&quot;, alpha = 0.9) +</span></span>
<span id="cb88-16"><a href="processing.html#cb88-16" tabindex="-1"></a>    harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp_d</span>(<span class="at">option =</span> <span class="st">&quot;lunalovegood&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb88-17"><a href="processing.html#cb88-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb88-18"><a href="processing.html#cb88-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>) <span class="sc">+</span></span>
<span id="cb88-19"><a href="processing.html#cb88-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(<span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T))</span>
<span id="cb88-20"><a href="processing.html#cb88-20" tabindex="-1"></a><span class="co"># add our study boundary</span></span>
<span id="cb88-21"><a href="processing.html#cb88-21" tabindex="-1"></a>r_plt <span class="sc">+</span></span>
<span id="cb88-22"><a href="processing.html#cb88-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_temp, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">fill =</span> <span class="cn">NA</span>)</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-73-1.png" alt="" width="1008" /></p>
</div>
<div id="combine-data" class="section level2 hasAnchor" number="2.9">
<h2><span class="header-section-number">2.9</span> Combine data<a href="processing.html#combine-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>before our last tree component calculation, we’ll bring all of our data together because the last component relies on this data</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="processing.html#cb89-1" tabindex="-1"></a><span class="co"># read all of our data back in</span></span>
<span id="cb89-2"><a href="processing.html#cb89-2" tabindex="-1"></a>trees_dbh_temp <span class="ot">&lt;-</span></span>
<span id="cb89-3"><a href="processing.html#cb89-3" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(</span>
<span id="cb89-4"><a href="processing.html#cb89-4" tabindex="-1"></a>    dbh_fnm</span>
<span id="cb89-5"><a href="processing.html#cb89-5" tabindex="-1"></a>    , <span class="at">col_select =</span> <span class="fu">c</span>(</span>
<span id="cb89-6"><a href="processing.html#cb89-6" tabindex="-1"></a>      treeID, tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;dbh&quot;</span>)</span>
<span id="cb89-7"><a href="processing.html#cb89-7" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;basal_area&quot;</span>)</span>
<span id="cb89-8"><a href="processing.html#cb89-8" tabindex="-1"></a>      , tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;radius&quot;</span>)</span>
<span id="cb89-9"><a href="processing.html#cb89-9" tabindex="-1"></a>    )</span>
<span id="cb89-10"><a href="processing.html#cb89-10" tabindex="-1"></a>    , <span class="at">show_col_types =</span> F</span>
<span id="cb89-11"><a href="processing.html#cb89-11" tabindex="-1"></a>    , <span class="at">progress =</span> F</span>
<span id="cb89-12"><a href="processing.html#cb89-12" tabindex="-1"></a>  )</span>
<span id="cb89-13"><a href="processing.html#cb89-13" tabindex="-1"></a>trees_cbh_temp <span class="ot">&lt;-</span></span>
<span id="cb89-14"><a href="processing.html#cb89-14" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(</span>
<span id="cb89-15"><a href="processing.html#cb89-15" tabindex="-1"></a>    cbh_fnm</span>
<span id="cb89-16"><a href="processing.html#cb89-16" tabindex="-1"></a>    , <span class="at">col_select =</span> <span class="fu">c</span>(treeID, tree_cbh_m, is_training_cbh)</span>
<span id="cb89-17"><a href="processing.html#cb89-17" tabindex="-1"></a>    , <span class="at">show_col_types =</span> F</span>
<span id="cb89-18"><a href="processing.html#cb89-18" tabindex="-1"></a>    , <span class="at">progress =</span> F</span>
<span id="cb89-19"><a href="processing.html#cb89-19" tabindex="-1"></a>  )</span>
<span id="cb89-20"><a href="processing.html#cb89-20" tabindex="-1"></a>trees_hmd_temp <span class="ot">&lt;-</span></span>
<span id="cb89-21"><a href="processing.html#cb89-21" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(</span>
<span id="cb89-22"><a href="processing.html#cb89-22" tabindex="-1"></a>    hmd_fnm</span>
<span id="cb89-23"><a href="processing.html#cb89-23" tabindex="-1"></a>    , <span class="at">col_select =</span> <span class="fu">c</span>(treeID, max_crown_diam_height_m, is_training_hmd)</span>
<span id="cb89-24"><a href="processing.html#cb89-24" tabindex="-1"></a>    , <span class="at">show_col_types =</span> F</span>
<span id="cb89-25"><a href="processing.html#cb89-25" tabindex="-1"></a>    , <span class="at">progress =</span> F</span>
<span id="cb89-26"><a href="processing.html#cb89-26" tabindex="-1"></a>  )</span>
<span id="cb89-27"><a href="processing.html#cb89-27" tabindex="-1"></a>trees_type_temp <span class="ot">&lt;-</span></span>
<span id="cb89-28"><a href="processing.html#cb89-28" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(</span>
<span id="cb89-29"><a href="processing.html#cb89-29" tabindex="-1"></a>    type_fnm</span>
<span id="cb89-30"><a href="processing.html#cb89-30" tabindex="-1"></a>    , <span class="at">col_select =</span> <span class="fu">c</span>(treeID, tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;forest_type&quot;</span>), hardwood_softwood)</span>
<span id="cb89-31"><a href="processing.html#cb89-31" tabindex="-1"></a>    , <span class="at">show_col_types =</span> F</span>
<span id="cb89-32"><a href="processing.html#cb89-32" tabindex="-1"></a>    , <span class="at">progress =</span> F</span>
<span id="cb89-33"><a href="processing.html#cb89-33" tabindex="-1"></a>  )</span>
<span id="cb89-34"><a href="processing.html#cb89-34" tabindex="-1"></a><span class="co"># function re-cast treeID if needed</span></span>
<span id="cb89-35"><a href="processing.html#cb89-35" tabindex="-1"></a>recast_id_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(df, cl) {</span>
<span id="cb89-36"><a href="processing.html#cb89-36" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb89-37"><a href="processing.html#cb89-37" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">inherits</span>(</span>
<span id="cb89-38"><a href="processing.html#cb89-38" tabindex="-1"></a>      df<span class="sc">$</span>treeID</span>
<span id="cb89-39"><a href="processing.html#cb89-39" tabindex="-1"></a>      , cl</span>
<span id="cb89-40"><a href="processing.html#cb89-40" tabindex="-1"></a>    )</span>
<span id="cb89-41"><a href="processing.html#cb89-41" tabindex="-1"></a>  ){</span>
<span id="cb89-42"><a href="processing.html#cb89-42" tabindex="-1"></a>    <span class="cf">if</span>(cl<span class="sc">==</span><span class="st">&quot;character&quot;</span>){</span>
<span id="cb89-43"><a href="processing.html#cb89-43" tabindex="-1"></a>      df<span class="sc">$</span>treeID <span class="ot">&lt;-</span> <span class="fu">format</span>(df<span class="sc">$</span>treeID, <span class="at">scientific =</span> F, <span class="at">trim =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb89-44"><a href="processing.html#cb89-44" tabindex="-1"></a>        <span class="fu">as.character</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb89-45"><a href="processing.html#cb89-45" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_squish</span>()</span>
<span id="cb89-46"><a href="processing.html#cb89-46" tabindex="-1"></a>    }<span class="cf">else</span> <span class="cf">if</span>(cl<span class="sc">==</span><span class="st">&quot;numeric&quot;</span>){</span>
<span id="cb89-47"><a href="processing.html#cb89-47" tabindex="-1"></a>      df<span class="sc">$</span>treeID <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df<span class="sc">$</span>treeID)</span>
<span id="cb89-48"><a href="processing.html#cb89-48" tabindex="-1"></a>    }</span>
<span id="cb89-49"><a href="processing.html#cb89-49" tabindex="-1"></a>  }</span>
<span id="cb89-50"><a href="processing.html#cb89-50" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb89-51"><a href="processing.html#cb89-51" tabindex="-1"></a>}</span>
<span id="cb89-52"><a href="processing.html#cb89-52" tabindex="-1"></a><span class="co"># apply</span></span>
<span id="cb89-53"><a href="processing.html#cb89-53" tabindex="-1"></a>trees_dbh_temp <span class="ot">&lt;-</span> trees_dbh_temp <span class="sc">%&gt;%</span> </span>
<span id="cb89-54"><a href="processing.html#cb89-54" tabindex="-1"></a>  <span class="fu">recast_id_fn</span>(<span class="at">cl =</span> <span class="fu">class</span>(treetops_sf<span class="sc">$</span>treeID))</span>
<span id="cb89-55"><a href="processing.html#cb89-55" tabindex="-1"></a>trees_cbh_temp <span class="ot">&lt;-</span> trees_cbh_temp <span class="sc">%&gt;%</span> </span>
<span id="cb89-56"><a href="processing.html#cb89-56" tabindex="-1"></a>  <span class="fu">recast_id_fn</span>(<span class="at">cl =</span> <span class="fu">class</span>(treetops_sf<span class="sc">$</span>treeID))</span>
<span id="cb89-57"><a href="processing.html#cb89-57" tabindex="-1"></a>trees_hmd_temp <span class="ot">&lt;-</span> trees_hmd_temp <span class="sc">%&gt;%</span> </span>
<span id="cb89-58"><a href="processing.html#cb89-58" tabindex="-1"></a>  <span class="fu">recast_id_fn</span>(<span class="at">cl =</span> <span class="fu">class</span>(treetops_sf<span class="sc">$</span>treeID))</span>
<span id="cb89-59"><a href="processing.html#cb89-59" tabindex="-1"></a>trees_type_temp <span class="ot">&lt;-</span> trees_type_temp <span class="sc">%&gt;%</span> </span>
<span id="cb89-60"><a href="processing.html#cb89-60" tabindex="-1"></a>  <span class="fu">recast_id_fn</span>(<span class="at">cl =</span> <span class="fu">class</span>(treetops_sf<span class="sc">$</span>treeID))</span>
<span id="cb89-61"><a href="processing.html#cb89-61" tabindex="-1"></a><span class="co"># now we&#39;ll get a list of the columns in our component data to drop from our main data</span></span>
<span id="cb89-62"><a href="processing.html#cb89-62" tabindex="-1"></a>cols_to_drop_temp <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb89-63"><a href="processing.html#cb89-63" tabindex="-1"></a>    <span class="fu">names</span>(trees_dbh_temp), <span class="fu">names</span>(trees_cbh_temp)</span>
<span id="cb89-64"><a href="processing.html#cb89-64" tabindex="-1"></a>    , <span class="fu">names</span>(trees_hmd_temp), <span class="fu">names</span>(trees_type_temp) </span>
<span id="cb89-65"><a href="processing.html#cb89-65" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb89-66"><a href="processing.html#cb89-66" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb89-67"><a href="processing.html#cb89-67" tabindex="-1"></a>  <span class="fu">setdiff</span>(<span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb89-68"><a href="processing.html#cb89-68" tabindex="-1"></a><span class="co"># remove cols from our primary data</span></span>
<span id="cb89-69"><a href="processing.html#cb89-69" tabindex="-1"></a>treetops_sf <span class="ot">&lt;-</span> treetops_sf <span class="sc">%&gt;%</span> </span>
<span id="cb89-70"><a href="processing.html#cb89-70" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(cols_to_drop_temp))</span>
<span id="cb89-71"><a href="processing.html#cb89-71" tabindex="-1"></a><span class="co"># join altogether using the magical purrr::reduce</span></span>
<span id="cb89-72"><a href="processing.html#cb89-72" tabindex="-1"></a>treetops_sf <span class="ot">&lt;-</span></span>
<span id="cb89-73"><a href="processing.html#cb89-73" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb89-74"><a href="processing.html#cb89-74" tabindex="-1"></a>    treetops_sf, trees_dbh_temp, trees_cbh_temp</span>
<span id="cb89-75"><a href="processing.html#cb89-75" tabindex="-1"></a>    , trees_hmd_temp, trees_type_temp</span>
<span id="cb89-76"><a href="processing.html#cb89-76" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb89-77"><a href="processing.html#cb89-77" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">reduce</span>(\(x,y) dplyr<span class="sc">::</span><span class="fu">left_join</span>(x, y, <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>))</span></code></pre></div>
<p>let’s glimpse our almost final data</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="processing.html#cb90-1" tabindex="-1"></a>treetops_sf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 625,378
## Columns: 23
## $ treeID                  &lt;chr&gt; &quot;270511_706700.2_4193508&quot;, &quot;273702_706701.7_41…
## $ tree_height_m           &lt;dbl&gt; 1.88, 4.37, 2.00, 6.13, 3.21, 4.08, 4.67, 5.79…
## $ tree_x                  &lt;dbl&gt; 706700.2, 706701.7, 706702.2, 706702.4, 706703…
## $ tree_y                  &lt;dbl&gt; 4193508, 4193500, 4193498, 4193502, 4193468, 4…
## $ crown_area_m2           &lt;dbl&gt; 0.5000, 4.6250, 1.1250, 5.7500, 1.5625, 2.8750…
## $ fia_est_dbh_cm          &lt;dbl&gt; 7.301241, 25.495789, 8.026274, 34.120251, 17.0…
## $ fia_est_dbh_cm_lower    &lt;dbl&gt; 3.237763, 11.244682, 3.579261, 15.115603, 7.47…
## $ fia_est_dbh_cm_upper    &lt;dbl&gt; 13.69907, 47.82657, 14.77090, 63.38588, 31.738…
## $ dbh_cm                  &lt;dbl&gt; 7.301241, 25.495789, 8.026274, 34.120251, 17.0…
## $ dbh_m                   &lt;dbl&gt; 0.07301241, 0.25495789, 0.08026274, 0.34120251…
## $ ptcld_extracted_dbh_cm  &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ ptcld_predicted_dbh_cm  &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ basal_area_m2           &lt;dbl&gt; 0.004186810, 0.051053648, 0.005059619, 0.09143…
## $ basal_area_ft2          &lt;dbl&gt; 0.04506683, 0.54954146, 0.05446174, 0.98421050…
## $ radius_m                &lt;dbl&gt; 0.03650621, 0.12747894, 0.04013137, 0.17060125…
## $ tree_cbh_m              &lt;dbl&gt; 1.667434, 2.422139, 1.701111, 3.307433, 2.1237…
## $ is_training_cbh         &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALS…
## $ max_crown_diam_height_m &lt;dbl&gt; 1.030000, 2.256222, 1.106201, 2.120000, 1.4513…
## $ is_training_hmd         &lt;lgl&gt; TRUE, FALSE, FALSE, TRUE, FALSE, TRUE, FALSE, …
## $ forest_type_group_code  &lt;dbl&gt; 180, 180, 180, 180, 180, 180, 180, 180, 180, 1…
## $ forest_type_group       &lt;chr&gt; &quot;Pinyon / juniper group&quot;, &quot;Pinyon / juniper gr…
## $ hardwood_softwood       &lt;chr&gt; &quot;Softwood&quot;, &quot;Softwood&quot;, &quot;Softwood&quot;, &quot;Softwood&quot;…
## $ geometry                &lt;POINT [m]&gt; POINT (706700.2 4193508), POINT (706701.…</code></pre>
</div>
<div id="crown-biomass-trees_biomass" class="section level2 hasAnchor" number="2.10">
<h2><span class="header-section-number">2.10</span> Crown Biomass: <code id="trees_biomass">trees_biomass()</code><a href="processing.html#crown-biomass-trees_biomass" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Lastly, we’ll use <code>trees_biomass()</code> to estimate tree crown biomass in kilograms. We’ll estimate biomass based on: 1) LANDFIRE’s <a href="https://landfire.gov/fuel/cbd">Forest Canopy Bulk Density (CBD) data</a>; and 2) based on the <a href="https://scholar.google.com/scholar?cluster=316241498622221569&amp;oi=gsb&amp;hl=en&amp;as_sdt=0,5">Cruz et al. (2003)</a> equations and the FIA forest type group we got above</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="processing.html#cb92-1" tabindex="-1"></a><span class="co"># where should we save the file?</span></span>
<span id="cb92-2"><a href="processing.html#cb92-2" tabindex="-1"></a>biomass_fnm <span class="ot">&lt;-</span> <span class="fu">file.path</span>(c2t_process_dir,<span class="st">&quot;biomass_data.csv&quot;</span>)</span>
<span id="cb92-3"><a href="processing.html#cb92-3" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb92-4"><a href="processing.html#cb92-4" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(biomass_fnm)){</span>
<span id="cb92-5"><a href="processing.html#cb92-5" tabindex="-1"></a>  <span class="co"># time it</span></span>
<span id="cb92-6"><a href="processing.html#cb92-6" tabindex="-1"></a>  st_temp <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb92-7"><a href="processing.html#cb92-7" tabindex="-1"></a>  <span class="co"># run it</span></span>
<span id="cb92-8"><a href="processing.html#cb92-8" tabindex="-1"></a>  trees_biomass_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">trees_biomass</span>(</span>
<span id="cb92-9"><a href="processing.html#cb92-9" tabindex="-1"></a>    <span class="at">tree_list =</span> treetops_sf</span>
<span id="cb92-10"><a href="processing.html#cb92-10" tabindex="-1"></a>    , <span class="at">method =</span> <span class="fu">c</span>(<span class="st">&quot;cruz&quot;</span>,<span class="st">&quot;landfire&quot;</span>)</span>
<span id="cb92-11"><a href="processing.html#cb92-11" tabindex="-1"></a>    , <span class="at">study_boundary =</span> </span>
<span id="cb92-12"><a href="processing.html#cb92-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(c2t_process_dir,<span class="st">&quot;raw_las_ctg_info.gpkg&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb92-13"><a href="processing.html#cb92-13" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_union</span>()</span>
<span id="cb92-14"><a href="processing.html#cb92-14" tabindex="-1"></a>  )</span>
<span id="cb92-15"><a href="processing.html#cb92-15" tabindex="-1"></a>  <span class="co"># timer</span></span>
<span id="cb92-16"><a href="processing.html#cb92-16" tabindex="-1"></a>  mins_temp <span class="ot">&lt;-</span> <span class="fu">difftime</span>(<span class="fu">Sys.time</span>(),st_temp,<span class="at">units =</span> <span class="st">&quot;mins&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb92-17"><a href="processing.html#cb92-17" tabindex="-1"></a>  <span class="co"># save biomass</span></span>
<span id="cb92-18"><a href="processing.html#cb92-18" tabindex="-1"></a>  trees_biomass_ans<span class="sc">$</span>tree_list <span class="sc">%&gt;%</span> </span>
<span id="cb92-19"><a href="processing.html#cb92-19" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb92-20"><a href="processing.html#cb92-20" tabindex="-1"></a>    <span class="fu">write.csv</span>(<span class="at">file =</span> biomass_fnm, <span class="at">row.names =</span> F, <span class="at">append =</span> F)</span>
<span id="cb92-21"><a href="processing.html#cb92-21" tabindex="-1"></a>  <span class="co"># save raster df</span></span>
<span id="cb92-22"><a href="processing.html#cb92-22" tabindex="-1"></a>  trees_biomass_ans<span class="sc">$</span>stand_cell_data_landfire <span class="sc">%&gt;%</span> </span>
<span id="cb92-23"><a href="processing.html#cb92-23" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb92-24"><a href="processing.html#cb92-24" tabindex="-1"></a>    <span class="fu">write.csv</span>(<span class="at">file =</span> <span class="fu">file.path</span>(c2t_process_dir,<span class="st">&quot;stand_cell_data_landfire.csv&quot;</span>), <span class="at">row.names =</span> F, <span class="at">append =</span> F)</span>
<span id="cb92-25"><a href="processing.html#cb92-25" tabindex="-1"></a>  trees_biomass_ans<span class="sc">$</span>stand_cell_data_cruz <span class="sc">%&gt;%</span> </span>
<span id="cb92-26"><a href="processing.html#cb92-26" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb92-27"><a href="processing.html#cb92-27" tabindex="-1"></a>    <span class="fu">write.csv</span>(<span class="at">file =</span> <span class="fu">file.path</span>(c2t_process_dir,<span class="st">&quot;stand_cell_data_cruz.csv&quot;</span>), <span class="at">row.names =</span> F, <span class="at">append =</span> F)</span>
<span id="cb92-28"><a href="processing.html#cb92-28" tabindex="-1"></a>  <span class="co"># save tracking</span></span>
<span id="cb92-29"><a href="processing.html#cb92-29" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(c2t_tracking_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb92-30"><a href="processing.html#cb92-30" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb92-31"><a href="processing.html#cb92-31" tabindex="-1"></a>      <span class="at">timer_trees_biomass_mins =</span> mins_temp</span>
<span id="cb92-32"><a href="processing.html#cb92-32" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb92-33"><a href="processing.html#cb92-33" tabindex="-1"></a>    <span class="fu">write.csv</span>(</span>
<span id="cb92-34"><a href="processing.html#cb92-34" tabindex="-1"></a>      <span class="at">file =</span> c2t_tracking_fnm</span>
<span id="cb92-35"><a href="processing.html#cb92-35" tabindex="-1"></a>      , <span class="at">row.names =</span> F, <span class="at">append =</span> F</span>
<span id="cb92-36"><a href="processing.html#cb92-36" tabindex="-1"></a>    )</span>
<span id="cb92-37"><a href="processing.html#cb92-37" tabindex="-1"></a>  </span>
<span id="cb92-38"><a href="processing.html#cb92-38" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb92-39"><a href="processing.html#cb92-39" tabindex="-1"></a>  trees_biomass_ans <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb92-40"><a href="processing.html#cb92-40" tabindex="-1"></a>  <span class="co"># biomass data</span></span>
<span id="cb92-41"><a href="processing.html#cb92-41" tabindex="-1"></a>  trees_biomass_ans<span class="sc">$</span>tree_list <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(biomass_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb92-42"><a href="processing.html#cb92-42" tabindex="-1"></a>  <span class="co"># raster</span></span>
<span id="cb92-43"><a href="processing.html#cb92-43" tabindex="-1"></a>  trees_biomass_ans<span class="sc">$</span>stand_cell_data_landfire <span class="ot">&lt;-</span> </span>
<span id="cb92-44"><a href="processing.html#cb92-44" tabindex="-1"></a>    readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="at">file =</span> <span class="fu">file.path</span>(c2t_process_dir,<span class="st">&quot;stand_cell_data_landfire.csv&quot;</span>), <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb92-45"><a href="processing.html#cb92-45" tabindex="-1"></a>  trees_biomass_ans<span class="sc">$</span>stand_cell_data_cruz <span class="ot">&lt;-</span> </span>
<span id="cb92-46"><a href="processing.html#cb92-46" tabindex="-1"></a>    readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="at">file =</span> <span class="fu">file.path</span>(c2t_process_dir,<span class="st">&quot;stand_cell_data_cruz.csv&quot;</span>), <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb92-47"><a href="processing.html#cb92-47" tabindex="-1"></a>}</span></code></pre></div>
<p>Tree crown biomass estimation took a total of <strong>5.2</strong> minutes at processing rate of <strong>0.35</strong> seconds per hectare</p>
<p>let’s look at the summary of the tree crown bulk density (CBD) values and the resulting crown biomass</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="processing.html#cb93-1" tabindex="-1"></a>trees_biomass_ans<span class="sc">$</span>tree_list <span class="sc">%&gt;%</span> </span>
<span id="cb93-2"><a href="processing.html#cb93-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb93-3"><a href="processing.html#cb93-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;tree_kg_per_m3&quot;</span>), tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;crown_biomass_kg&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb93-4"><a href="processing.html#cb93-4" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##  cruz_tree_kg_per_m3 landfire_tree_kg_per_m3 cruz_crown_biomass_kg
##  Min.   :0.4         Min.   :0.09936         Min.   :  0.0        
##  1st Qu.:0.9         1st Qu.:0.53931         1st Qu.:  1.4        
##  Median :1.0         Median :0.70857         Median :  4.4        
##  Mean   :1.0         Mean   :0.75114         Mean   :  8.7        
##  3rd Qu.:1.2         3rd Qu.:0.89114         3rd Qu.: 11.4        
##  Max.   :2.0         Max.   :1.99737         Max.   :435.6        
##  NA&#39;s   :605499                              NA&#39;s   :605499       
##  landfire_crown_biomass_kg
##  Min.   :  0.0013         
##  1st Qu.:  0.8059         
##  Median :  2.5805         
##  Mean   :  5.6171         
##  3rd Qu.:  6.6420         
##  Max.   :793.2737         
## </code></pre>
<p>note those NA values for the Cruz et al. (2003) method, these NA values are introduced because this particular methodology is limited to the forest types for which biomass equations exist</p>
<p>check out the break-down by FIA forest type group</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="processing.html#cb95-1" tabindex="-1"></a>trees_biomass_ans<span class="sc">$</span>tree_list <span class="sc">%&gt;%</span> </span>
<span id="cb95-2"><a href="processing.html#cb95-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb95-3"><a href="processing.html#cb95-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(forest_type_group)) <span class="sc">%&gt;%</span> </span>
<span id="cb95-4"><a href="processing.html#cb95-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(forest_type_group) <span class="sc">%&gt;%</span> </span>
<span id="cb95-5"><a href="processing.html#cb95-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb95-6"><a href="processing.html#cb95-6" tabindex="-1"></a>    <span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb95-7"><a href="processing.html#cb95-7" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb95-8"><a href="processing.html#cb95-8" tabindex="-1"></a>      cruz_tree_kg_per_m3</span>
<span id="cb95-9"><a href="processing.html#cb95-9" tabindex="-1"></a>      , <span class="at">.fns =</span> <span class="fu">list</span>(<span class="at">mean =</span> mean, <span class="at">sd =</span> sd, <span class="at">min =</span> min, <span class="at">max =</span> max)</span>
<span id="cb95-10"><a href="processing.html#cb95-10" tabindex="-1"></a>    )</span>
<span id="cb95-11"><a href="processing.html#cb95-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb95-12"><a href="processing.html#cb95-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="sc">~</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(.x,<span class="st">&quot;cruz_tree_kg_per_m3_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb95-13"><a href="processing.html#cb95-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb95-14"><a href="processing.html#cb95-14" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">&quot;Summary of tree CBD (kg per m3) by FIA Forest Type Group&quot;</span>, <span class="at">digits =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-15"><a href="processing.html#cb95-15" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()  </span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-81">Table 2.2: </span>Summary of tree CBD (kg per m3) by FIA Forest Type Group
</caption>
<thead>
<tr>
<th style="text-align:left;">
forest_type_group
</th>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
mean
</th>
<th style="text-align:right;">
sd
</th>
<th style="text-align:right;">
min
</th>
<th style="text-align:right;">
max
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Pinyon / juniper group
</td>
<td style="text-align:right;">
605364
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
Ponderosa pine group
</td>
<td style="text-align:right;">
19879
</td>
<td style="text-align:right;">
1.04
</td>
<td style="text-align:right;">
0.27
</td>
<td style="text-align:right;">
0.36
</td>
<td style="text-align:right;">
1.99
</td>
</tr>
<tr>
<td style="text-align:left;">
Woodland hardwoods group
</td>
<td style="text-align:right;">
135
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
</tr>
</tbody>
</table>
<p>Let’s check the distribution of CBD values estimated in our study area but only for trees that had both Cruz et al. (2003) and LANDFIRE estimates</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="processing.html#cb96-1" tabindex="-1"></a>trees_biomass_ans<span class="sc">$</span>tree_list <span class="sc">%&gt;%</span> </span>
<span id="cb96-2"><a href="processing.html#cb96-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb96-3"><a href="processing.html#cb96-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;tree_kg_per_m3&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb96-4"><a href="processing.html#cb96-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>dplyr<span class="sc">::</span><span class="fu">if_any</span>(<span class="at">.cols =</span> dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="at">.fns =</span> <span class="sc">~</span><span class="fu">is.na</span>(.x))) <span class="sc">%&gt;%</span> </span>
<span id="cb96-5"><a href="processing.html#cb96-5" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> tidyselect<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb96-6"><a href="processing.html#cb96-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">name =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name,<span class="st">&quot;_tree_kg_per_m3&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb96-7"><a href="processing.html#cb96-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> name, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb96-8"><a href="processing.html#cb96-8" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb96-9"><a href="processing.html#cb96-9" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)) <span class="sc">+</span></span>
<span id="cb96-10"><a href="processing.html#cb96-10" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>, <span class="at">begin =</span> <span class="fl">0.3</span>, <span class="at">end =</span> <span class="fl">0.7</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">name =</span> <span class="st">&quot;biomass method&quot;</span>) <span class="sc">+</span></span>
<span id="cb96-11"><a href="processing.html#cb96-11" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>, <span class="at">begin =</span> <span class="fl">0.3</span>, <span class="at">end =</span> <span class="fl">0.7</span>,<span class="at">name =</span> <span class="st">&quot;biomass method&quot;</span>) <span class="sc">+</span></span>
<span id="cb96-12"><a href="processing.html#cb96-12" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb96-13"><a href="processing.html#cb96-13" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;tree kilograms per cubic meter&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb96-14"><a href="processing.html#cb96-14" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb96-15"><a href="processing.html#cb96-15" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-82-1.png" alt="" width="1008" /></p>
<p>We can see how the LANDFIRE <a href="https://landfire.gov/fuel/cbd">Forest Canopy Bulk Density (CBD) data</a> and <a href="https://scholar.google.com/scholar?cluster=316241498622221569&amp;oi=gsb&amp;hl=en&amp;as_sdt=0,5">Cruz et al. (2003)</a> methodologies compare at estimating tree crown biomass for our study area</p>
<p>we’ll make this comparison only for trees that have biomass estimated using the Cruz method as well</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="processing.html#cb97-1" tabindex="-1"></a><span class="co"># set the upper limit scale</span></span>
<span id="cb97-2"><a href="processing.html#cb97-2" tabindex="-1"></a>ul_temp <span class="ot">&lt;-</span> <span class="fu">max</span>(</span>
<span id="cb97-3"><a href="processing.html#cb97-3" tabindex="-1"></a>  <span class="fu">quantile</span>(trees_biomass_ans<span class="sc">$</span>tree_list<span class="sc">$</span>cruz_crown_biomass_kg, <span class="at">probs =</span> <span class="fl">0.95</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb97-4"><a href="processing.html#cb97-4" tabindex="-1"></a>  , <span class="fu">quantile</span>(trees_biomass_ans<span class="sc">$</span>tree_list<span class="sc">$</span>landfire_crown_biomass_kg, <span class="at">probs =</span> <span class="fl">0.95</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb97-5"><a href="processing.html#cb97-5" tabindex="-1"></a>)</span>
<span id="cb97-6"><a href="processing.html#cb97-6" tabindex="-1"></a><span class="co"># plot tree landfire vs. cruz crown biomass estimate</span></span>
<span id="cb97-7"><a href="processing.html#cb97-7" tabindex="-1"></a>trees_biomass_ans<span class="sc">$</span>tree_list <span class="sc">%&gt;%</span></span>
<span id="cb97-8"><a href="processing.html#cb97-8" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb97-9"><a href="processing.html#cb97-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cruz_crown_biomass_kg)) <span class="sc">%&gt;%</span> </span>
<span id="cb97-10"><a href="processing.html#cb97-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">11111</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb97-11"><a href="processing.html#cb97-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb97-12"><a href="processing.html#cb97-12" tabindex="-1"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb97-13"><a href="processing.html#cb97-13" tabindex="-1"></a>      <span class="at">x =</span> landfire_crown_biomass_kg, <span class="at">y =</span> cruz_crown_biomass_kg</span>
<span id="cb97-14"><a href="processing.html#cb97-14" tabindex="-1"></a>    )</span>
<span id="cb97-15"><a href="processing.html#cb97-15" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb97-16"><a href="processing.html#cb97-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">lwd =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb97-17"><a href="processing.html#cb97-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> tree_height_m)) <span class="sc">+</span></span>
<span id="cb97-18"><a href="processing.html#cb97-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se=</span>F, <span class="at">color =</span> <span class="st">&quot;tomato&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb97-19"><a href="processing.html#cb97-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;mako&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb97-20"><a href="processing.html#cb97-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, ul_temp)) <span class="sc">+</span></span>
<span id="cb97-21"><a href="processing.html#cb97-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, ul_temp)) <span class="sc">+</span></span>
<span id="cb97-22"><a href="processing.html#cb97-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb97-23"><a href="processing.html#cb97-23" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;LANDFIRE crown biomass (kg)&quot;</span></span>
<span id="cb97-24"><a href="processing.html#cb97-24" tabindex="-1"></a>    , <span class="at">y =</span> <span class="st">&quot;Cruz crown biomass (kg)&quot;</span></span>
<span id="cb97-25"><a href="processing.html#cb97-25" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;tree ht. (m)&quot;</span></span>
<span id="cb97-26"><a href="processing.html#cb97-26" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb97-27"><a href="processing.html#cb97-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>()</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-83-1.png" alt="" width="1008" /></p>
<p>we can summarize the average difference between the two methods for records with both estimates</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="processing.html#cb98-1" tabindex="-1"></a>trees_biomass_ans<span class="sc">$</span>tree_list <span class="sc">%&gt;%</span></span>
<span id="cb98-2"><a href="processing.html#cb98-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb98-3"><a href="processing.html#cb98-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cruz_crown_biomass_kg)) <span class="sc">%&gt;%</span> </span>
<span id="cb98-4"><a href="processing.html#cb98-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb98-5"><a href="processing.html#cb98-5" tabindex="-1"></a>    <span class="at">diff_cruz_lf_kg =</span> cruz_crown_biomass_kg<span class="sc">-</span>landfire_crown_biomass_kg</span>
<span id="cb98-6"><a href="processing.html#cb98-6" tabindex="-1"></a>    , <span class="at">pct_diff_cruz_lf_kg =</span> diff_cruz_lf_kg<span class="sc">/</span>landfire_crown_biomass_kg</span>
<span id="cb98-7"><a href="processing.html#cb98-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb98-8"><a href="processing.html#cb98-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb98-9"><a href="processing.html#cb98-9" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb98-10"><a href="processing.html#cb98-10" tabindex="-1"></a>      <span class="fu">c</span>(cruz_crown_biomass_kg,landfire_crown_biomass_kg,diff_cruz_lf_kg,pct_diff_cruz_lf_kg)</span>
<span id="cb98-11"><a href="processing.html#cb98-11" tabindex="-1"></a>      , <span class="at">.fns =</span> <span class="fu">list</span>(<span class="at">mean =</span> mean)</span>
<span id="cb98-12"><a href="processing.html#cb98-12" tabindex="-1"></a>      , <span class="at">.names =</span> <span class="st">&quot;{.fn}_{.col}&quot;</span></span>
<span id="cb98-13"><a href="processing.html#cb98-13" tabindex="-1"></a>    )</span>
<span id="cb98-14"><a href="processing.html#cb98-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb98-15"><a href="processing.html#cb98-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb98-16"><a href="processing.html#cb98-16" tabindex="-1"></a>    <span class="at">mean_pct_diff_cruz_lf_kg =</span> scales<span class="sc">::</span><span class="fu">percent</span>(mean_pct_diff_cruz_lf_kg, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb98-17"><a href="processing.html#cb98-17" tabindex="-1"></a>    , dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb98-18"><a href="processing.html#cb98-18" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="sc">-</span>mean_pct_diff_cruz_lf_kg</span>
<span id="cb98-19"><a href="processing.html#cb98-19" tabindex="-1"></a>      , <span class="at">.fns =</span> <span class="sc">~</span>scales<span class="sc">::</span><span class="fu">comma</span>(.x,<span class="at">accuracy =</span> <span class="fl">0.01</span>)</span>
<span id="cb98-20"><a href="processing.html#cb98-20" tabindex="-1"></a>    )</span>
<span id="cb98-21"><a href="processing.html#cb98-21" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb98-22"><a href="processing.html#cb98-22" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(tidyselect<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb98-23"><a href="processing.html#cb98-23" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">&quot;Mean difference between LANDFIRE and Cruz estimated tree crown biomass in kilograms&quot;</span>, <span class="at">digits =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb98-24"><a href="processing.html#cb98-24" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()  </span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-84">Table 2.3: </span>Mean difference between LANDFIRE and Cruz estimated tree crown biomass in kilograms
</caption>
<thead>
<tr>
<th style="text-align:left;">
name
</th>
<th style="text-align:left;">
value
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
mean_cruz_crown_biomass_kg
</td>
<td style="text-align:left;">
8.65
</td>
</tr>
<tr>
<td style="text-align:left;">
mean_landfire_crown_biomass_kg
</td>
<td style="text-align:left;">
5.22
</td>
</tr>
<tr>
<td style="text-align:left;">
mean_diff_cruz_lf_kg
</td>
<td style="text-align:left;">
3.43
</td>
</tr>
<tr>
<td style="text-align:left;">
mean_pct_diff_cruz_lf_kg
</td>
<td style="text-align:left;">
130.9%
</td>
</tr>
</tbody>
</table>
<p>Finally, let’s plot the spatial arrangement of estimated biomass using the raster data returned from <code>trees_biomass()</code></p>
<p>First, for LANDFIRE</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="processing.html#cb99-1" tabindex="-1"></a><span class="co"># aoi</span></span>
<span id="cb99-2"><a href="processing.html#cb99-2" tabindex="-1"></a>aoi_temp <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="st">&quot;../data/point_cloud_processing_delivery/raw_las_ctg_info.gpkg&quot;</span>)</span></code></pre></div>
<pre><code>## Reading layer `raw_las_ctg_info&#39; from data source 
##   `C:\Data\usfs\blm_trfo_uas\data\point_cloud_processing_delivery\raw_las_ctg_info.gpkg&#39; 
##   using driver `GPKG&#39;
## Simple feature collection with 156 features and 34 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 706698.8 ymin: 4191874 xmax: 710919.1 ymax: 4194616
## Projected CRS: NAD83(2011) / UTM zone 12N</code></pre>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="processing.html#cb101-1" tabindex="-1"></a><span class="co"># get the projection for the stand cell data</span></span>
<span id="cb101-2"><a href="processing.html#cb101-2" tabindex="-1"></a>epsg_code_temp <span class="ot">&lt;-</span> trees_biomass_ans<span class="sc">$</span>stand_cell_data_landfire<span class="sc">$</span>rast_epsg_code[<span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb101-3"><a href="processing.html#cb101-3" tabindex="-1"></a><span class="co"># set the color limit</span></span>
<span id="cb101-4"><a href="processing.html#cb101-4" tabindex="-1"></a>ul_temp <span class="ot">&lt;-</span> <span class="fu">max</span>(</span>
<span id="cb101-5"><a href="processing.html#cb101-5" tabindex="-1"></a>  <span class="fu">max</span>(trees_biomass_ans<span class="sc">$</span>stand_cell_data_landfire<span class="sc">$</span>landfire_stand_kg_per_m3, <span class="at">na.rm =</span> T)</span>
<span id="cb101-6"><a href="processing.html#cb101-6" tabindex="-1"></a>  , <span class="fu">max</span>(trees_biomass_ans<span class="sc">$</span>stand_cell_data_cruz<span class="sc">$</span>cruz_stand_kg_per_m3, <span class="at">na.rm =</span> T)</span>
<span id="cb101-7"><a href="processing.html#cb101-7" tabindex="-1"></a>)</span>
<span id="cb101-8"><a href="processing.html#cb101-8" tabindex="-1"></a><span class="co"># plot the stand cell data with trees overlaid</span></span>
<span id="cb101-9"><a href="processing.html#cb101-9" tabindex="-1"></a>trees_biomass_ans<span class="sc">$</span>stand_cell_data_landfire <span class="sc">%&gt;%</span></span>
<span id="cb101-10"><a href="processing.html#cb101-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(trees<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-11"><a href="processing.html#cb101-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb101-12"><a href="processing.html#cb101-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">fill =</span> landfire_stand_kg_per_m3), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb101-13"><a href="processing.html#cb101-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_temp <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="at">crs =</span> epsg_code_temp), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb101-14"><a href="processing.html#cb101-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;LANDFIRE stand kg/m3&quot;</span>, <span class="at">fill=</span><span class="st">&quot;LANDFIRE</span><span class="sc">\n</span><span class="st">stand kg/m3&quot;</span>) <span class="sc">+</span></span>
<span id="cb101-15"><a href="processing.html#cb101-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(</span>
<span id="cb101-16"><a href="processing.html#cb101-16" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="cn">NA</span>,ul_temp)</span>
<span id="cb101-17"><a href="processing.html#cb101-17" tabindex="-1"></a>    , <span class="at">option =</span> <span class="st">&quot;rocket&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">na.value =</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb101-18"><a href="processing.html#cb101-18" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb101-19"><a href="processing.html#cb101-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">coord_sf</span>() <span class="sc">+</span></span>
<span id="cb101-20"><a href="processing.html#cb101-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-85-1.png" alt="" width="1008" /></p>
<p>and for Cruz</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="processing.html#cb102-1" tabindex="-1"></a><span class="co"># get the projection for the stand cell data</span></span>
<span id="cb102-2"><a href="processing.html#cb102-2" tabindex="-1"></a>epsg_code_temp <span class="ot">&lt;-</span> trees_biomass_ans<span class="sc">$</span>stand_cell_data_cruz<span class="sc">$</span>rast_epsg_code[<span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb102-3"><a href="processing.html#cb102-3" tabindex="-1"></a><span class="co"># plot the stand cell data with trees overlaid</span></span>
<span id="cb102-4"><a href="processing.html#cb102-4" tabindex="-1"></a>trees_biomass_ans<span class="sc">$</span>stand_cell_data_cruz <span class="sc">%&gt;%</span></span>
<span id="cb102-5"><a href="processing.html#cb102-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(trees<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb102-6"><a href="processing.html#cb102-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb102-7"><a href="processing.html#cb102-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">fill =</span> cruz_stand_kg_per_m3), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb102-8"><a href="processing.html#cb102-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> aoi_temp <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="at">crs =</span> epsg_code_temp), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb102-9"><a href="processing.html#cb102-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;Cruz stand kg/m3&quot;</span>, <span class="at">fill=</span><span class="st">&quot;Cruz</span><span class="sc">\n</span><span class="st">stand kg/m3&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-10"><a href="processing.html#cb102-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>(</span>
<span id="cb102-11"><a href="processing.html#cb102-11" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="cn">NA</span>,ul_temp)</span>
<span id="cb102-12"><a href="processing.html#cb102-12" tabindex="-1"></a>    , <span class="at">option =</span> <span class="st">&quot;rocket&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">na.value =</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb102-13"><a href="processing.html#cb102-13" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb102-14"><a href="processing.html#cb102-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="blm_trfo_uas_files/figure-html/unnamed-chunk-86-1.png" alt="" width="1008" /></p>
</div>
<div id="processing-time-summary" class="section level2 hasAnchor" number="2.11">
<h2><span class="header-section-number">2.11</span> Processing Time Summary<a href="processing.html#processing-time-summary" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s summarize how long all of this point cloud processing took and determine which steps were most computationally intensive.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="processing.html#cb103-1" tabindex="-1"></a><span class="co"># aggregate the total processing time</span></span>
<span id="cb103-2"><a href="processing.html#cb103-2" tabindex="-1"></a>processing_data <span class="ot">&lt;-</span> </span>
<span id="cb103-3"><a href="processing.html#cb103-3" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(c2t_tracking_fnm, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb103-4"><a href="processing.html#cb103-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb103-5"><a href="processing.html#cb103-5" tabindex="-1"></a>    <span class="at">timer_total_time_mins =</span> timer_cloud2raster_mins <span class="sc">+</span> timer_raster2trees_mins <span class="sc">+</span></span>
<span id="cb103-6"><a href="processing.html#cb103-6" tabindex="-1"></a>      timer_trees_dbh_mins <span class="sc">+</span> timer_trees_cbh_mins <span class="sc">+</span> timer_trees_type_mins <span class="sc">+</span></span>
<span id="cb103-7"><a href="processing.html#cb103-7" tabindex="-1"></a>      timer_trees_hmd_mins <span class="sc">+</span> timer_trees_biomass_mins</span>
<span id="cb103-8"><a href="processing.html#cb103-8" tabindex="-1"></a>    , <span class="at">timer_tree_extraction_mins =</span> timer_cloud2raster_mins <span class="sc">+</span> timer_raster2trees_mins</span>
<span id="cb103-9"><a href="processing.html#cb103-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb103-10"><a href="processing.html#cb103-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb103-11"><a href="processing.html#cb103-11" tabindex="-1"></a>     <span class="at">.cols =</span> <span class="fu">c</span>(timer_tree_extraction_mins,</span>
<span id="cb103-12"><a href="processing.html#cb103-12" tabindex="-1"></a>      timer_trees_dbh_mins, timer_trees_cbh_mins, timer_trees_type_mins,</span>
<span id="cb103-13"><a href="processing.html#cb103-13" tabindex="-1"></a>      timer_trees_hmd_mins, timer_trees_biomass_mins)</span>
<span id="cb103-14"><a href="processing.html#cb103-14" tabindex="-1"></a>     , <span class="at">.fns =</span> <span class="sc">~</span> .x<span class="sc">/</span>timer_total_time_mins</span>
<span id="cb103-15"><a href="processing.html#cb103-15" tabindex="-1"></a>     , <span class="at">.names =</span> <span class="st">&quot;{.col}_pct&quot;</span></span>
<span id="cb103-16"><a href="processing.html#cb103-16" tabindex="-1"></a>  ))</span>
<span id="cb103-17"><a href="processing.html#cb103-17" tabindex="-1"></a><span class="co"># table it</span></span>
<span id="cb103-18"><a href="processing.html#cb103-18" tabindex="-1"></a>table_temp <span class="ot">&lt;-</span> processing_data <span class="sc">%&gt;%</span> </span>
<span id="cb103-19"><a href="processing.html#cb103-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb103-20"><a href="processing.html#cb103-20" tabindex="-1"></a>    <span class="fu">c</span>(timer_tree_extraction_mins,</span>
<span id="cb103-21"><a href="processing.html#cb103-21" tabindex="-1"></a>      timer_trees_dbh_mins, timer_trees_cbh_mins, timer_trees_type_mins,</span>
<span id="cb103-22"><a href="processing.html#cb103-22" tabindex="-1"></a>      timer_trees_hmd_mins, timer_trees_biomass_mins</span>
<span id="cb103-23"><a href="processing.html#cb103-23" tabindex="-1"></a>      , <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_pct&quot;</span>) <span class="sc">&amp;</span> tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;timer_&quot;</span>))</span>
<span id="cb103-24"><a href="processing.html#cb103-24" tabindex="-1"></a>    )</span>
<span id="cb103-25"><a href="processing.html#cb103-25" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb103-26"><a href="processing.html#cb103-26" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb103-27"><a href="processing.html#cb103-27" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb103-28"><a href="processing.html#cb103-28" tabindex="-1"></a>    <span class="at">units =</span> stringr<span class="sc">::</span><span class="fu">word</span>(name, <span class="sc">-</span><span class="dv">1</span>, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb103-29"><a href="processing.html#cb103-29" tabindex="-1"></a>    , <span class="at">section =</span> name <span class="sc">%&gt;%</span> </span>
<span id="cb103-30"><a href="processing.html#cb103-30" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;timer_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb103-31"><a href="processing.html#cb103-31" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;_mins&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb103-32"><a href="processing.html#cb103-32" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;_pct&quot;</span>)</span>
<span id="cb103-33"><a href="processing.html#cb103-33" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb103-34"><a href="processing.html#cb103-34" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb103-35"><a href="processing.html#cb103-35" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> units, <span class="at">values_from =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb103-36"><a href="processing.html#cb103-36" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb103-37"><a href="processing.html#cb103-37" tabindex="-1"></a>    <span class="at">mins_lab =</span> scales<span class="sc">::</span><span class="fu">comma</span>(mins,<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb103-38"><a href="processing.html#cb103-38" tabindex="-1"></a>    , <span class="at">pct_lab =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct,<span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb103-39"><a href="processing.html#cb103-39" tabindex="-1"></a>  )</span></code></pre></div>
<p>table it</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="processing.html#cb104-1" tabindex="-1"></a>table_temp <span class="sc">%&gt;%</span> </span>
<span id="cb104-2"><a href="processing.html#cb104-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(section, tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_lab&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-3"><a href="processing.html#cb104-3" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb104-4"><a href="processing.html#cb104-4" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Point cloud processing section run time&quot;</span></span>
<span id="cb104-5"><a href="processing.html#cb104-5" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb104-6"><a href="processing.html#cb104-6" tabindex="-1"></a>      <span class="st">&quot;Processing section&quot;</span></span>
<span id="cb104-7"><a href="processing.html#cb104-7" tabindex="-1"></a>      , <span class="st">&quot;time (minutes)&quot;</span></span>
<span id="cb104-8"><a href="processing.html#cb104-8" tabindex="-1"></a>      , <span class="st">&quot;% of total time&quot;</span></span>
<span id="cb104-9"><a href="processing.html#cb104-9" tabindex="-1"></a>      )</span>
<span id="cb104-10"><a href="processing.html#cb104-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb104-11"><a href="processing.html#cb104-11" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-88">Table 2.4: </span>Point cloud processing section run time
</caption>
<thead>
<tr>
<th style="text-align:left;">
Processing section
</th>
<th style="text-align:left;">
time (minutes)
</th>
<th style="text-align:left;">
% of total time
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
tree_extraction
</td>
<td style="text-align:left;">
340.6
</td>
<td style="text-align:left;">
38.8%
</td>
</tr>
<tr>
<td style="text-align:left;">
trees_dbh
</td>
<td style="text-align:left;">
7.9
</td>
<td style="text-align:left;">
0.9%
</td>
</tr>
<tr>
<td style="text-align:left;">
trees_cbh
</td>
<td style="text-align:left;">
319.6
</td>
<td style="text-align:left;">
36.4%
</td>
</tr>
<tr>
<td style="text-align:left;">
trees_type
</td>
<td style="text-align:left;">
0.4
</td>
<td style="text-align:left;">
0.0%
</td>
</tr>
<tr>
<td style="text-align:left;">
trees_hmd
</td>
<td style="text-align:left;">
203.5
</td>
<td style="text-align:left;">
23.2%
</td>
</tr>
<tr>
<td style="text-align:left;">
trees_biomass
</td>
<td style="text-align:left;">
5.2
</td>
<td style="text-align:left;">
0.6%
</td>
</tr>
</tbody>
</table>
</div>
<div id="data-export" class="section level2 hasAnchor" number="2.12">
<h2><span class="header-section-number">2.12</span> Data Export<a href="processing.html#data-export" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now that we have our point cloud-extracted tree list with all of the tree component measurements attached, let’s save the data for use in our analysis</p>
<p>first we’ll attach the biomass metrics to our spatial tree list</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="processing.html#cb105-1" tabindex="-1"></a><span class="co"># new columns added by trees_biomass()</span></span>
<span id="cb105-2"><a href="processing.html#cb105-2" tabindex="-1"></a>names_temp <span class="ot">&lt;-</span> </span>
<span id="cb105-3"><a href="processing.html#cb105-3" tabindex="-1"></a>  <span class="fu">setdiff</span>(</span>
<span id="cb105-4"><a href="processing.html#cb105-4" tabindex="-1"></a>    trees_biomass_ans<span class="sc">$</span>tree_list <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span>
<span id="cb105-5"><a href="processing.html#cb105-5" tabindex="-1"></a>    , treetops_sf <span class="sc">%&gt;%</span> </span>
<span id="cb105-6"><a href="processing.html#cb105-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;cruz_&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb105-7"><a href="processing.html#cb105-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;landfire_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb105-8"><a href="processing.html#cb105-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb105-9"><a href="processing.html#cb105-9" tabindex="-1"></a>        <span class="st">&quot;crown_dia_m&quot;</span>,<span class="st">&quot;crown_length_m&quot;</span>,<span class="st">&quot;crown_volume_m3&quot;</span></span>
<span id="cb105-10"><a href="processing.html#cb105-10" tabindex="-1"></a>      ))) <span class="sc">%&gt;%</span> </span>
<span id="cb105-11"><a href="processing.html#cb105-11" tabindex="-1"></a>      <span class="fu">names</span>()</span>
<span id="cb105-12"><a href="processing.html#cb105-12" tabindex="-1"></a>  )</span>
<span id="cb105-13"><a href="processing.html#cb105-13" tabindex="-1"></a><span class="co"># recast id if needed</span></span>
<span id="cb105-14"><a href="processing.html#cb105-14" tabindex="-1"></a>trees_biomass_ans<span class="sc">$</span>tree_list <span class="ot">&lt;-</span></span>
<span id="cb105-15"><a href="processing.html#cb105-15" tabindex="-1"></a>  trees_biomass_ans<span class="sc">$</span>tree_list <span class="sc">%&gt;%</span> </span>
<span id="cb105-16"><a href="processing.html#cb105-16" tabindex="-1"></a>  <span class="fu">recast_id_fn</span>(<span class="at">cl =</span> <span class="fu">class</span>(treetops_sf<span class="sc">$</span>treeID))</span>
<span id="cb105-17"><a href="processing.html#cb105-17" tabindex="-1"></a><span class="co"># attach to our spatial tree points</span></span>
<span id="cb105-18"><a href="processing.html#cb105-18" tabindex="-1"></a>treetops_sf <span class="ot">&lt;-</span></span>
<span id="cb105-19"><a href="processing.html#cb105-19" tabindex="-1"></a>  treetops_sf <span class="sc">%&gt;%</span> </span>
<span id="cb105-20"><a href="processing.html#cb105-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;cruz_&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb105-21"><a href="processing.html#cb105-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;landfire_&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb105-22"><a href="processing.html#cb105-22" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb105-23"><a href="processing.html#cb105-23" tabindex="-1"></a>    <span class="st">&quot;crown_dia_m&quot;</span>,<span class="st">&quot;crown_length_m&quot;</span>,<span class="st">&quot;crown_volume_m3&quot;</span></span>
<span id="cb105-24"><a href="processing.html#cb105-24" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span> </span>
<span id="cb105-25"><a href="processing.html#cb105-25" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb105-26"><a href="processing.html#cb105-26" tabindex="-1"></a>    trees_biomass_ans<span class="sc">$</span>tree_list <span class="sc">%&gt;%</span></span>
<span id="cb105-27"><a href="processing.html#cb105-27" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb105-28"><a href="processing.html#cb105-28" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">&quot;treeID&quot;</span>, names_temp)))</span>
<span id="cb105-29"><a href="processing.html#cb105-29" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb105-30"><a href="processing.html#cb105-30" tabindex="-1"></a>  )</span>
<span id="cb105-31"><a href="processing.html#cb105-31" tabindex="-1"></a><span class="co"># what does our final data look like?</span></span>
<span id="cb105-32"><a href="processing.html#cb105-32" tabindex="-1"></a>treetops_sf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 625,378
## Columns: 34
## $ treeID                    &lt;chr&gt; &quot;270511_706700.2_4193508&quot;, &quot;273702_706701.7_…
## $ tree_height_m             &lt;dbl&gt; 1.88, 4.37, 2.00, 6.13, 3.21, 4.08, 4.67, 5.…
## $ tree_x                    &lt;dbl&gt; 706700.2, 706701.7, 706702.2, 706702.4, 7067…
## $ tree_y                    &lt;dbl&gt; 4193508, 4193500, 4193498, 4193502, 4193468,…
## $ crown_area_m2             &lt;dbl&gt; 0.5000, 4.6250, 1.1250, 5.7500, 1.5625, 2.87…
## $ fia_est_dbh_cm            &lt;dbl&gt; 7.301241, 25.495789, 8.026274, 34.120251, 17…
## $ fia_est_dbh_cm_lower      &lt;dbl&gt; 3.237763, 11.244682, 3.579261, 15.115603, 7.…
## $ fia_est_dbh_cm_upper      &lt;dbl&gt; 13.69907, 47.82657, 14.77090, 63.38588, 31.7…
## $ dbh_cm                    &lt;dbl&gt; 7.301241, 25.495789, 8.026274, 34.120251, 17…
## $ dbh_m                     &lt;dbl&gt; 0.07301241, 0.25495789, 0.08026274, 0.341202…
## $ ptcld_extracted_dbh_cm    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ ptcld_predicted_dbh_cm    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ basal_area_m2             &lt;dbl&gt; 0.004186810, 0.051053648, 0.005059619, 0.091…
## $ basal_area_ft2            &lt;dbl&gt; 0.04506683, 0.54954146, 0.05446174, 0.984210…
## $ radius_m                  &lt;dbl&gt; 0.03650621, 0.12747894, 0.04013137, 0.170601…
## $ tree_cbh_m                &lt;dbl&gt; 1.667434, 2.422139, 1.701111, 3.307433, 2.12…
## $ is_training_cbh           &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FA…
## $ max_crown_diam_height_m   &lt;dbl&gt; 1.030000, 2.256222, 1.106201, 2.120000, 1.45…
## $ is_training_hmd           &lt;lgl&gt; TRUE, FALSE, FALSE, TRUE, FALSE, TRUE, FALSE…
## $ forest_type_group_code    &lt;dbl&gt; 180, 180, 180, 180, 180, 180, 180, 180, 180,…
## $ forest_type_group         &lt;chr&gt; &quot;Pinyon / juniper group&quot;, &quot;Pinyon / juniper …
## $ hardwood_softwood         &lt;chr&gt; &quot;Softwood&quot;, &quot;Softwood&quot;, &quot;Softwood&quot;, &quot;Softwoo…
## $ cruz_stand_id             &lt;dbl&gt; 8933, 9119, 9119, 9119, 9305, 9305, 9119, 91…
## $ cruz_tree_kg_per_m3       &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ cruz_stand_kg_per_m3      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ cruz_crown_biomass_kg     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ landfire_stand_id         &lt;dbl&gt; 4594, 4594, 4594, 4594, 4742, 4742, 4594, 45…
## $ crown_dia_m               &lt;dbl&gt; 0.7978846, 2.4266712, 1.1968268, 2.7057582, …
## $ crown_length_m            &lt;dbl&gt; 0.2125661, 1.9478610, 0.2988889, 2.8225668, …
## $ crown_volume_m3           &lt;dbl&gt; 0.07085537, 6.00590471, 0.22416667, 10.81983…
## $ landfire_tree_kg_per_m3   &lt;dbl&gt; 0.7581083, 0.7581083, 0.7581083, 0.7581083, …
## $ landfire_stand_kg_per_m3  &lt;dbl&gt; 0.27, 0.27, 0.27, 0.27, 0.27, 0.27, 0.27, 0.…
## $ landfire_crown_biomass_kg &lt;dbl&gt; 0.05371604, 4.55312599, 0.16994260, 8.202609…
## $ geometry                  &lt;POINT [m]&gt; POINT (706700.2 4193508), POINT (70670…</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="processing.html#cb107-1" tabindex="-1"></a><span class="co"># where should we save the file?</span></span>
<span id="cb107-2"><a href="processing.html#cb107-2" tabindex="-1"></a>treetops_fnm <span class="ot">&lt;-</span> <span class="fu">file.path</span>(c2t_process_dir,<span class="st">&quot;final_detected_tree_tops_attr.gpkg&quot;</span>)</span>
<span id="cb107-3"><a href="processing.html#cb107-3" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb107-4"><a href="processing.html#cb107-4" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(treetops_fnm)){</span>
<span id="cb107-5"><a href="processing.html#cb107-5" tabindex="-1"></a>  treetops_sf <span class="sc">%&gt;%</span> </span>
<span id="cb107-6"><a href="processing.html#cb107-6" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_write</span>(<span class="at">dsn =</span> treetops_fnm, <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb107-7"><a href="processing.html#cb107-7" tabindex="-1"></a>}</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="slash-piles.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

</body>

</html>
